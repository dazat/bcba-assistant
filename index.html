<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCBA Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f8f6f2;
  --surface: #ffffff;
  --surface2: #f2efe9;
  --surface3: #ebe7df;
  --border: #ddd9d0;
  --text: #2d2820;
  --text-mid: #6b6157;
  --text-muted: #a89f94;
  --sage: #5a7a5f;
  --sage-light: #e6f0e7;
  --sage-dark: #3d5c42;
  --terra: #8b5e3c;
  --terra-light: #f5ece4;
  --amber: #b07d2a;
  --amber-light: #fdf5e0;
  --slate: #3d5a7a;
  --slate-light: #e8eef5;
  --rose: #9e5a5a;
  --rose-light: #f9eaea;
  --shadow: 0 2px 8px rgba(45,40,32,0.07), 0 1px 2px rgba(45,40,32,0.04);
  --shadow-lg: 0 8px 32px rgba(45,40,32,0.13);
  --r: 14px;
  --sidebar: 256px;
  --base: 15px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: var(--base);
  line-height: 1.65;
}

h1,h2,h3,.logo-mark,.card-head,.modal-title,.topbar-title,.profile-name,.empty-title {
  font-family: 'Quicksand', sans-serif;
  font-weight: 700;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: var(--sidebar);
  background: #2d2820;
  display: flex;
  flex-direction: column;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  z-index: 200;
  transition: transform 0.25s ease;
}

.sidebar-logo {
  padding: 26px 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.07);
}

.logo-mark {
  font-size: 19px;
  color: #fff;
  letter-spacing: -0.2px;
}

.logo-sub {
  font-family: 'Nunito', sans-serif;
  font-size: 11px;
  color: rgba(255,255,255,0.35);
  letter-spacing: 0.8px;
  text-transform: uppercase;
  margin-top: 3px;
}

.sidebar-section { padding: 16px 12px 4px; }

.sidebar-label {
  font-family: 'Nunito', sans-serif;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.28);
  padding: 0 8px;
  margin-bottom: 4px;
}

.nav-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: none;
  background: none;
  color: rgba(255,255,255,0.52);
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
}

.nav-btn:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.85); }
.nav-btn.active { background: rgba(90,122,95,0.3); color: #fff; font-weight: 700; }
.nav-btn .ni { font-size: 15px; width: 20px; text-align: center; flex-shrink: 0; }

.client-items { padding: 0 12px 4px; }

.client-row {
  display: flex;
  align-items: center;
  gap: 9px;
  width: 100%;
  padding: 8px 12px;
  border-radius: 10px;
  border: none;
  background: none;
  color: rgba(255,255,255,0.48);
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
}

.client-row:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
.client-row.active { background: rgba(90,122,95,0.28); color: #fff; font-weight: 700; }

.ca {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: rgba(255,255,255,0.09);
  color: rgba(255,255,255,0.65);
  font-family: 'Quicksand', sans-serif;
  font-size: 10px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  letter-spacing: 0.2px;
}

.client-row.active .ca { background: var(--sage); color: white; }

.add-client {
  display: flex;
  align-items: center;
  gap: 8px;
  width: calc(100% - 24px);
  margin: 4px 12px;
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px dashed rgba(255,255,255,0.13);
  background: none;
  color: rgba(255,255,255,0.35);
  font-family: 'Nunito', sans-serif;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
}

.add-client:hover { border-color: rgba(255,255,255,0.28); color: rgba(255,255,255,0.65); }

.sidebar-footer {
  margin-top: auto;
  padding: 12px;
  border-top: 1px solid rgba(255,255,255,0.07);
}

.api-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 9px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  background: none;
  color: rgba(255,255,255,0.38);
  font-family: 'Nunito', sans-serif;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
}

.api-btn:hover { border-color: rgba(255,255,255,0.22); color: rgba(255,255,255,0.65); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main { margin-left: var(--sidebar); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }

.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}

.topbar-left { display: flex; align-items: center; gap: 12px; }
.menu-btn { display: none; background: none; border: none; font-size: 21px; cursor: pointer; color: var(--text-mid); padding: 2px 4px; }
.topbar-title { font-size: 20px; color: var(--text); }
.topbar-sub { font-family: 'Nunito', sans-serif; font-size: 12px; color: var(--text-muted); margin-top: 1px; }
.api-status { display: flex; align-items: center; gap: 7px; font-size: 12px; color: var(--text-muted); }
.dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
.dot.on { background: var(--sage); }

.content { padding: 24px 28px; max-width: 920px; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 22px 24px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}

.card-head {
  font-size: 17px;
  color: var(--text);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.badge {
  font-family: 'Nunito', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.4px;
  padding: 3px 10px;
  border-radius: 20px;
}

.badge-sage { background: var(--sage-light); color: var(--sage-dark); }
.badge-terra { background: var(--terra-light); color: var(--terra); }
.badge-amber { background: var(--amber-light); color: var(--amber); }
.badge-slate { background: var(--slate-light); color: var(--slate); }
.badge-rose { background: var(--rose-light); color: var(--rose); }

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
label {
  display: block;
  font-family: 'Nunito', sans-serif;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-muted);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-bottom: 6px;
}

input[type=text], textarea, select {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font-family: 'Nunito', sans-serif;
  font-size: 15px;
  color: var(--text);
  background: var(--bg);
  outline: none;
  transition: border-color 0.15s;
  resize: vertical;
}

input[type=text]:focus, textarea:focus, select:focus {
  border-color: var(--sage);
  background: #fff;
}

textarea { min-height: 90px; }
.fg { margin-bottom: 15px; }
.fg2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 15px; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  border-radius: 10px;
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
}

.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-primary { background: var(--text); color: #fff; }
.btn-primary:hover:not(:disabled) { background: #444; }
.btn-sage { background: var(--sage); color: #fff; }
.btn-sage:hover:not(:disabled) { background: var(--sage-dark); }
.btn-ghost { background: var(--surface2); color: var(--text-mid); border: 1.5px solid var(--border); }
.btn-ghost:hover { background: var(--surface3); }
.btn-sm { padding: 7px 14px; font-size: 13px; }
.btn-xs { padding: 4px 10px; font-size: 12px; border-radius: 7px; }
.btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px; }

/* ‚îÄ‚îÄ OUTPUT ‚îÄ‚îÄ */
.output {
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  padding: 16px 18px;
  font-size: 14px;
  line-height: 1.8;
  white-space: pre-wrap;
  color: var(--text);
  margin-top: 14px;
  min-height: 60px;
}

.out-actions { display: flex; gap: 8px; margin-top: 10px; justify-content: flex-end; }

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.ld { display: inline-flex; gap: 3px; align-items: center; }
.ld span { width: 5px; height: 5px; border-radius: 50%; background: currentColor; animation: ld 1.2s infinite; }
.ld span:nth-child(2) { animation-delay: 0.2s; }
.ld span:nth-child(3) { animation-delay: 0.4s; }
@keyframes ld { 0%,80%,100%{transform:scale(0.6);opacity:0.4} 40%{transform:scale(1);opacity:1} }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs {
  display: flex;
  gap: 2px;
  background: var(--surface2);
  padding: 4px;
  border-radius: 12px;
  margin-bottom: 20px;
  overflow-x: auto;
}

.tab {
  flex: 1;
  min-width: max-content;
  padding: 8px 14px;
  border-radius: 9px;
  font-family: 'Nunito', sans-serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-muted);
  cursor: pointer;
  border: none;
  background: none;
  transition: all 0.15s;
  white-space: nowrap;
  text-align: center;
}

.tab.active { background: var(--surface); color: var(--text); box-shadow: var(--shadow); font-weight: 700; }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page { display: none; }
.page.active { display: block; }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(45,40,32,0.48);
  z-index: 300;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.overlay.open { display: flex; }

.modal {
  background: var(--surface);
  border-radius: var(--r);
  padding: 28px;
  max-width: 520px;
  width: 100%;
  box-shadow: var(--shadow-lg);
  max-height: 90vh;
  overflow-y: auto;
}

.modal-title { font-size: 20px; margin-bottom: 20px; color: var(--text); }
.modal-actions { display: flex; gap: 8px; margin-top: 20px; justify-content: flex-end; }

/* ‚îÄ‚îÄ DASHBOARD OVERVIEW ‚îÄ‚îÄ */
.client-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }

.client-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--r);
  padding: 18px 20px;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: all 0.15s;
}

.client-card:hover { border-color: var(--sage); transform: translateY(-1px); box-shadow: var(--shadow-lg); }

.cc-top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }

.cc-av {
  width: 44px; height: 44px;
  border-radius: 50%;
  background: var(--sage-light);
  color: var(--sage-dark);
  font-family: 'Quicksand', sans-serif;
  font-size: 14px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.cc-name { font-family: 'Quicksand', sans-serif; font-size: 18px; font-weight: 700; }
.cc-goals { font-size: 13px; color: var(--text-muted); }

.cc-stats { display: flex; gap: 8px; flex-wrap: wrap; }

.cc-stat {
  font-size: 12px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 20px;
  background: var(--surface2);
  color: var(--text-mid);
}

.cc-stat.alert { background: var(--rose-light); color: var(--rose); }
.cc-stat.warn { background: var(--amber-light); color: var(--amber); }
.cc-stat.good { background: var(--sage-light); color: var(--sage-dark); }

/* ‚îÄ‚îÄ PROFILE BAR ‚îÄ‚îÄ */
.profile-bar {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 20px;
  padding: 16px 20px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--r);
  box-shadow: var(--shadow);
}

.profile-av {
  width: 48px; height: 48px;
  border-radius: 50%;
  background: var(--sage-light);
  color: var(--sage-dark);
  font-family: 'Quicksand', sans-serif;
  font-size: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.profile-name { font-size: 22px; }
.profile-meta { font-family: 'Nunito', sans-serif; font-size: 13px; color: var(--text-muted); margin-top: 1px; }

/* ‚îÄ‚îÄ GOAL ITEMS ‚îÄ‚îÄ */
.goal-item {
  border: 1.5px solid var(--border);
  border-radius: 12px;
  margin-bottom: 10px;
  overflow: hidden;
}

.goal-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: var(--surface2);
}

.goal-title {
  flex: 1;
  font-family: 'Quicksand', sans-serif;
  font-size: 15px;
  font-weight: 700;
}

.goal-body { padding: 12px 16px; background: var(--surface); }

.goal-edit-input {
  font-family: 'Quicksand', sans-serif;
  font-size: 15px;
  font-weight: 700;
  border: 1.5px solid var(--sage);
  border-radius: 7px;
  padding: 4px 8px;
  background: white;
  color: var(--text);
  flex: 1;
}

.subgoal-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 7px 10px;
  border-radius: 8px;
  font-size: 14px;
  border: 1.5px solid var(--border);
  margin-bottom: 6px;
  background: var(--bg);
}

.subgoal-text { flex: 1; }
.subgoal-edit { flex: 1; font-family: 'Nunito', sans-serif; font-size: 14px; border: 1.5px solid var(--sage); border-radius: 7px; padding: 3px 8px; background: white; color: var(--text); }

/* ‚îÄ‚îÄ TARGET ITEMS ‚îÄ‚îÄ */
.target-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  margin-bottom: 7px;
  font-size: 14px;
  background: var(--surface);
}

.target-status {
  font-family: 'Nunito', sans-serif;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.3px;
  text-transform: uppercase;
  padding: 3px 10px;
  border-radius: 20px;
}

.ts-active { background: var(--sage-light); color: var(--sage-dark); }
.ts-mastered { background: var(--amber-light); color: var(--amber); }
.ts-disc { background: var(--surface3); color: var(--text-muted); }

/* ‚îÄ‚îÄ MONITORING ‚îÄ‚îÄ */
.monitor-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 8px;
  padding: 12px 16px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  margin-bottom: 8px;
  background: var(--surface);
  font-size: 14px;
}

.overdue { border-color: #e8aaaa; background: #fff5f5; }
.due-soon { border-color: #e8d0a0; background: var(--amber-light); }

/* ‚îÄ‚îÄ TRAINING SECTIONS ‚îÄ‚îÄ */
.tsec {
  border: 1.5px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 10px;
}

.tsec-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--surface2);
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  border: none;
  width: 100%;
  text-align: left;
  color: var(--text-mid);
}

.tsec-body {
  padding: 16px;
  font-size: 14px;
  line-height: 1.8;
  white-space: pre-wrap;
  background: var(--surface);
}

/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
.chat-wrap {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 210px);
  min-height: 400px;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 12px 12px 0 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.msg {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.7;
}

.msg-user { background: var(--text); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
.msg-ai { background: var(--surface); color: var(--text); align-self: flex-start; border: 1.5px solid var(--border); border-bottom-left-radius: 4px; }
.msg-label { font-family: 'Nunito', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px; color: var(--text-muted); }

.chat-input-row {
  display: flex;
  gap: 8px;
  padding: 10px 12px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-top: none;
  border-radius: 0 0 12px 12px;
}

.chat-input-row textarea { flex: 1; min-height: 46px; max-height: 120px; resize: none; }

/* ‚îÄ‚îÄ NOTE TEMPLATES ‚îÄ‚îÄ */
.tpl-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 13px 16px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  margin-bottom: 8px;
  background: var(--surface);
  transition: all 0.15s;
}

.tpl-item.selected { border-color: var(--sage); background: var(--sage-light); }

.tpl-check {
  width: 20px; height: 20px;
  border: 2px solid var(--border);
  border-radius: 5px;
  flex-shrink: 0;
  margin-top: 2px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  background: white;
}

.tpl-item.selected .tpl-check { background: var(--sage); border-color: var(--sage); color: white; font-size: 12px; }

.tpl-content { flex: 1; min-width: 0; }
.tpl-title { font-family: 'Quicksand', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 3px; }
.tpl-preview { font-size: 13px; color: var(--text-muted); }

.tpl-actions { display: flex; gap: 6px; flex-shrink: 0; }

/* editing state */
.tpl-edit-title { font-family: 'Quicksand', sans-serif; font-size: 15px; font-weight: 700; border: 1.5px solid var(--sage); border-radius: 7px; padding: 3px 8px; background: white; color: var(--text); width: 100%; margin-bottom: 6px; }
.tpl-edit-text { font-family: 'Nunito', sans-serif; font-size: 14px; border: 1.5px solid var(--sage); border-radius: 7px; padding: 6px 8px; background: white; color: var(--text); width: 100%; min-height: 70px; resize: vertical; }

/* ‚îÄ‚îÄ MEETING LOG ‚îÄ‚îÄ */
.meeting-entry { border: 1.5px solid var(--border); border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
.meeting-head { display: flex; align-items: center; justify-content: space-between; padding: 11px 16px; background: var(--surface2); font-size: 14px; cursor: pointer; }
.meeting-body { padding: 14px 16px; font-size: 14px; line-height: 1.75; white-space: pre-wrap; }

/* ‚îÄ‚îÄ SETUP BANNER ‚îÄ‚îÄ */
.setup-banner {
  background: var(--slate-light);
  border: 1.5px solid #c5d5e8;
  border-radius: var(--r);
  padding: 14px 18px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--slate);
}

.alert-amber {
  padding: 11px 16px;
  border-radius: 10px;
  font-size: 14px;
  margin-bottom: 12px;
  background: var(--amber-light);
  color: #7a5800;
  border: 1.5px solid #e8d0a0;
}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty { text-align: center; padding: 52px 20px; color: var(--text-muted); }
.empty-icon { font-size: 36px; margin-bottom: 12px; }
.empty-title { font-size: 20px; color: var(--text); margin-bottom: 8px; }
.empty-text { font-size: 14px; }

/* ‚îÄ‚îÄ MIC ‚îÄ‚îÄ */
.mic-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 5px 11px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--surface2);
  color: var(--text-mid);
  font-family: 'Nunito', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  vertical-align: middle;
  margin-left: 6px;
}

.mic-btn:hover { border-color: var(--sage); color: var(--sage); }
.mic-btn.recording { background: var(--rose-light); border-color: var(--rose); color: var(--rose); animation: pulse 1s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.55} }

hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
.login-screen {
  display: none;
  position: fixed;
  inset: 0;
  background: #2d2820;
  z-index: 9999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 0;
}

.login-screen.visible { display: flex; }

.login-box {
  background: var(--surface);
  border-radius: 20px;
  padding: 40px 36px;
  max-width: 360px;
  width: 90%;
  box-shadow: var(--shadow-lg);
  text-align: center;
}

.login-logo {
  font-family: 'Quicksand', sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
}

.login-sub {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 28px;
}

.login-box input[type=password] {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-family: 'Nunito', sans-serif;
  font-size: 16px;
  text-align: center;
  letter-spacing: 4px;
  outline: none;
  transition: border-color 0.15s;
  margin-bottom: 12px;
}

.login-box input[type=password]:focus { border-color: var(--sage); }

.login-error {
  font-size: 13px;
  color: var(--rose);
  margin-bottom: 10px;
  min-height: 18px;
}

.login-hint {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 16px;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ CHANGE PASSWORD ‚îÄ‚îÄ */
.change-pw-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: none;
  color: rgba(255,255,255,0.3);
  font-family: 'Nunito', sans-serif;
  font-size: 12px;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  width: 100%;
  transition: all 0.15s;
}

.change-pw-btn:hover { color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.05); }
/* ‚îÄ‚îÄ CLIENT CONTEXT BAR ‚îÄ‚îÄ */
.ctx-bar {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--r);
  padding: 13px 18px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  box-shadow: var(--shadow);
}

.ctx-bar-label {
  font-family: 'Nunito', sans-serif;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-muted);
  white-space: nowrap;
}

.ctx-bar select {
  flex: 1;
  min-width: 140px;
  max-width: 220px;
  padding: 7px 12px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 9px;
  border: 1.5px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-family: 'Nunito', sans-serif;
}

.ctx-bar select:focus { border-color: var(--sage); outline: none; }

.ctx-toggle {
  display: flex;
  align-items: center;
  gap: 7px;
  font-family: 'Nunito', sans-serif;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-mid);
  cursor: pointer;
  white-space: nowrap;
}

.ctx-toggle input[type=checkbox] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--sage); }

.ctx-summary {
  flex: 1;
  font-size: 12px;
  color: var(--text-muted);
  line-height: 1.5;
  min-width: 180px;
}

.ctx-summary strong { color: var(--sage-dark); font-weight: 700; }

.ctx-bar.no-client { border-color: var(--border); background: var(--surface2); }
.ctx-bar.has-client { border-color: #b0d0b5; background: var(--sage-light); }
.ctx-bar.has-client .ctx-bar-label { color: var(--sage-dark); }

/* ‚îÄ‚îÄ RBT FIELD COPY ‚îÄ‚îÄ */
.rbt-field {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
}

.rbt-field:last-child { border-bottom: none; }

.rbt-field-label {
  font-family: 'Nunito', sans-serif;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: var(--text-muted);
  width: 200px;
  flex-shrink: 0;
  padding-top: 2px;
}

.rbt-field-value {
  flex: 1;
  font-size: 14px;
  line-height: 1.6;
  color: var(--text);
}

.rbt-field-copy {
  flex-shrink: 0;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 3px 9px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
  font-family: 'Nunito', sans-serif;
}

.rbt-field-copy:hover { background: var(--sage-light); color: var(--sage-dark); border-color: var(--sage); }

.rbt-fields-wrap {
  border: 1.5px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 14px;
  background: var(--surface);
}

/* ‚îÄ‚îÄ CR COPY BUTTON ‚îÄ‚îÄ */
.btn-cr {
  background: #1a6b3c;
  color: white;
  font-size: 13px;
}

.btn-cr:hover { background: #145530; }

/* ‚îÄ‚îÄ DOC REVIEW ‚îÄ‚îÄ */
.review-section {
  border: 1.5px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 12px;
}

.review-section-head {
  padding: 10px 14px;
  background: var(--surface2);
  font-size: 13px;
  font-weight: 700;
  color: var(--text-mid);
  display: flex;
  align-items: center;
  gap: 8px;
}

.review-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 9px 14px;
  border-top: 1px solid var(--border);
  font-size: 13px;
}

.review-item input[type=checkbox] { margin-top: 3px; flex-shrink: 0; }

.review-item-text {
  flex: 1;
  line-height: 1.6;
  outline: none;
  border-radius: 4px;
  padding: 1px 4px;
  min-width: 0;
}

.review-item-text:focus { background: var(--sage-light); }
.backup-banner {
  background: #fff8ec;
  border: 1.5px solid #f0d080;
  border-radius: var(--r);
  padding: 13px 18px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 14px;
  color: #7a5800;
}

.backup-banner strong { font-weight: 700; }
.backup-banner-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
.backup-dismiss { background: none; border: none; color: #b08040; cursor: pointer; font-size: 18px; padding: 0 4px; line-height: 1; }
.backup-dismiss:hover { color: #7a5800; }

/* ‚îÄ‚îÄ EXPORT/IMPORT ‚îÄ‚îÄ */
.data-btn {
  display: flex;
  align-items: center;
  gap: 7px;
  width: 100%;
  padding: 8px 12px;
  border-radius: 9px;
  border: none;
  background: none;
  color: rgba(255,255,255,0.38);
  font-family: 'Nunito', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  margin-top: 2px;
}

.data-btn:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.7); }

/* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
@media print {
  .sidebar, .topbar, .no-print { display: none !important; }
  .main { margin-left: 0; }
  .print-area { display: block; }
  .content { display: none; }
}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main { margin-left: 0; }
  .topbar { padding: 12px 16px; }
  .content { padding: 14px 16px; }
  .fg2 { grid-template-columns: 1fr; }
  .menu-btn { display: block; }
  .client-cards { grid-template-columns: 1fr; }
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ‚ïê‚ïê DOCUMENT UPLOAD MODAL ‚ïê‚ïê -->
<div class="overlay" id="modalUploadDoc">
  <div class="modal" style="max-width:560px">
    <div class="modal-title">üìÑ Import from Document</div>

    <div style="background:var(--sage-light);border:1.5px solid #b0d0b5;border-radius:10px;padding:14px 16px;margin-bottom:18px;font-size:13px;line-height:1.7;color:var(--sage-dark)">
      <strong>What this does:</strong> Upload a clinical document (assessment report, behavior plan, IEP, or any document listing goals and targets) and the AI will read it and extract the client's goals, sub-goals, and targets automatically ‚Äî saving you from re-typing everything manually.<br><br>
      <strong>Works best with:</strong> PDF exports from Central Reach, assessment summaries, IEP documents, or photos of printed reports.<br><br>
      <strong>Privacy note:</strong> The document content is sent to Anthropic's API for reading. Use documents with initials only where possible, consistent with how you use the rest of this tool.
    </div>

    <div style="background:var(--amber-light);border:1.5px solid #e8d0a0;border-radius:10px;padding:12px 16px;margin-bottom:18px;font-size:13px;color:#7a5800">
      ‚ö†Ô∏è <strong>Always review before saving.</strong> The AI extraction is a starting point ‚Äî you'll confirm or edit everything before it's added to the client profile.
    </div>

    <div class="fg">
      <label>Select Document (PDF or Image)</label>
      <input type="file" id="docUploadInput" accept=".pdf,.png,.jpg,.jpeg,.heic" style="font-size:14px;padding:8px;border:1.5px solid var(--border);border-radius:10px;width:100%;background:var(--bg)">
    </div>

    <div class="fg">
      <label>Any context to help the AI (optional)</label>
      <input type="text" id="docUploadContext" placeholder="e.g. This is an IEP from school. Focus on communication and behavior goals.">
    </div>

    <div id="docUploadError" style="color:var(--rose);font-size:13px;margin-bottom:8px;display:none"></div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalUploadDoc')">Cancel</button>
      <button class="btn btn-primary" id="docUploadBtn" onclick="processDocumentUpload()">üìÑ Read Document</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê DOCUMENT REVIEW MODAL ‚ïê‚ïê -->
<div class="overlay" id="modalDocReview">
  <div class="modal" style="max-width:600px">
    <div class="modal-title">‚úÖ Review Extracted Data</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px;line-height:1.6">Review what was found in the document. Uncheck anything you don't want to add. Edit any text by clicking it. Then click Save to add to the client profile.</p>

    <div id="docReviewContent"></div>

    <div id="docReviewError" style="color:var(--rose);font-size:13px;margin-top:8px;display:none"></div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalDocReview')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExtractedData()">‚úì Save to Client Profile</button>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê SAVE STRATEGY FROM CHAT MODAL ‚ïê‚ïê -->
<div class="overlay" id="modalSaveStrategy">
  <div class="modal">
    <div class="modal-title">üí° Save Strategy to Profile</div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;line-height:1.6">Give this strategy a title and set its status. Edit the text to trim it down if needed.</p>
    <div class="fg"><label>Title</label><input type="text" id="modalStratTitle" placeholder="e.g. Visual transition schedule"></div>
    <div class="fg"><label>Strategy Text</label><textarea id="modalStratText" rows="5"></textarea></div>
    <div class="fg">
      <label>Status</label>
      <select id="modalStratStatus">
        <option value="trying">üîÑ Trying / To Try</option>
        <option value="worked">‚úÖ Worked</option>
        <option value="didnt-work">‚ùå Didn't Work</option>
      </select>
    </div>
    <input type="hidden" id="modalStratClientId">
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalSaveStrategy')">Cancel</button>
      <button class="btn btn-primary" onclick="saveStrategyFromModal()">üí° Save to Profile</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalAddClient">
  <div class="modal">
    <div class="modal-title">Add New Client</div>
    <div class="fg2">
      <div class="fg"><label>First Name Initials</label><input type="text" id="ncFirst" maxlength="3" placeholder="Ja"></div>
      <div class="fg"><label>Last Name Initials</label><input type="text" id="ncLast" maxlength="3" placeholder="Do"></div>
    </div>
    <div class="fg"><label>Primary Goals (comma separated)</label><input type="text" id="ncGoals" placeholder="e.g. Communication, Self-regulation"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddClient')">Cancel</button>
      <button class="btn btn-primary" onclick="saveNewClient()">Add Client</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalApiKey">
  <div class="modal">
    <div class="modal-title">API Key Settings</div>
    <p style="font-size:14px;color:var(--text-muted);margin-bottom:14px;line-height:1.65">Your key is stored only in this browser and sent directly to Anthropic. Never stored on any server.</p>
    <div class="fg"><label>Anthropic API Key</label><input type="text" id="apiInput" placeholder="sk-ant-..." autocomplete="off"></div>
    <p style="font-size:12px;color:var(--text-muted)">Get your key at <strong>console.anthropic.com</strong> ‚Üí API Keys</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalApiKey')">Cancel</button>
      <button class="btn btn-primary" onclick="saveKey()">Save Key</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalAddGoal">
  <div class="modal">
    <div class="modal-title">Add Goal</div>
    <div class="fg"><label>Main Goal</label><input type="text" id="goalMain" placeholder="e.g. Functional Communication"></div>
    <div class="fg"><label>Sub-goals (one per line)</label><textarea id="goalSubs" rows="4" placeholder="e.g.&#10;Mand for preferred items&#10;Tact common objects&#10;PECS Phase 1"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddGoal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGoal()">Add Goal</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalAddTarget">
  <div class="modal">
    <div class="modal-title">Add Target</div>
    <div class="fg"><label>Target Name</label><input type="text" id="targetName" placeholder="e.g. Imitate clap hands"></div>
    <div class="fg"><label>Status</label>
      <select id="targetStatus">
        <option value="active">Active</option>
        <option value="mastered">Mastered</option>
        <option value="discontinued">Discontinued</option>
      </select>
    </div>
    <div class="fg"><label>Notes (optional)</label><input type="text" id="targetNotes" placeholder="e.g. DTT, 80% criterion"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddTarget')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTarget()">Add Target</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalAddMonitor">
  <div class="modal">
    <div class="modal-title">Add Monitoring Item</div>

    <div class="fg">
      <label>Select from Goals / Targets</label>
      <select id="monGoalSelect" onchange="handleMonitorSelect(this.value)" style="margin-bottom:8px">
        <option value="">‚Äî Pick from existing goals or targets ‚Äî</option>
      </select>
    </div>

    <div class="fg">
      <label>Goal / Behavior to Monitor <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text-muted);font-size:11px">‚Äî edit or type your own</span></label>
      <input type="text" id="monGoal" placeholder="e.g. Elopement frequency">
    </div>

    <div class="fg2">
      <div class="fg"><label>Start Date</label><input type="text" id="monDate" placeholder="e.g. 2/26/2025"></div>
      <div class="fg"><label>Tracking Frequency</label>
        <select id="monFreq">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="biweekly">Bi-weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
    </div>
    <div class="fg"><label>Last Tracked Date</label><input type="text" id="monLastDate" placeholder="e.g. 2/20/2025"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddMonitor')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMonitor()">Add Item</button>
    </div>
  </div>
</div>

<div class="overlay" id="modalAddMeeting">
  <div class="modal">
    <div class="modal-title">Log Parent Meeting</div>
    <div class="fg"><label>Meeting Date</label><input type="text" id="meetDate" placeholder="e.g. 2/26/2025"></div>
    <div class="fg"><label>Topics Discussed</label><textarea id="meetTopics" rows="3" placeholder="e.g. Reviewed elopement data. Discussed token economy at home."></textarea></div>
    <div class="fg"><label>Feedback Given to Family</label><textarea id="meetFeedback" rows="3" placeholder="e.g. Advised consistent visual schedule before transitions."></textarea></div>
    <div class="fg"><label>Follow-up Items</label><textarea id="meetFollowup" rows="2" placeholder="e.g. Check in on sleep schedule next session."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddMeeting')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMeeting()">Save Log</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê -->
<div class="login-screen visible" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">BCBA Assistant ‚ú®</div>
    <div class="login-sub">Clinical Support Tool</div>
    <input type="password" id="pwInput" placeholder="Enter password" onkeydown="if(event.key==='Enter')checkPassword()">
    <div class="login-error" id="pwError"></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px" onclick="checkPassword()">Unlock</button>
    <div class="login-hint">First time? Default password is <strong>bcba2024</strong><br>Change it after logging in via the sidebar.</div>
  </div>
</div>

<!-- ‚ïê‚ïê CHANGE PASSWORD MODAL ‚ïê‚ïê -->
<div class="overlay" id="modalChangePw">
  <div class="modal">
    <div class="modal-title">Change Password</div>
    <div class="fg"><label>Current Password</label><input type="password" id="pwCurrent" placeholder="Current password"></div>
    <div class="fg"><label>New Password</label><input type="password" id="pwNew" placeholder="New password (min 4 characters)"></div>
    <div class="fg"><label>Confirm New Password</label><input type="password" id="pwConfirm" placeholder="Repeat new password"></div>
    <div class="login-error" id="pwChangeError"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalChangePw')">Cancel</button>
      <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div style="display:flex;min-height:100vh">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">BCBA Assistant ‚ú®</div>
      <div class="logo-sub">Clinical Support Tool</div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Tools</div>
      <button class="nav-btn active" data-page="dashboard" onclick="showPage('dashboard',this)"><span class="ni">üè†</span> Dashboard</button>
      <button class="nav-btn" data-page="bip" onclick="showPage('bip',this)"><span class="ni">üìã</span> BIP Generator</button>
      <button class="nav-btn" data-page="rbt" onclick="showPage('rbt',this)"><span class="ni">üìù</span> RBT Program Sheet</button>
      <button class="nav-btn" data-page="parent" onclick="showPage('parent',this)"><span class="ni">üë®‚Äçüë©‚Äçüëß</span> Parent Training</button>
      <button class="nav-btn" data-page="stuck" onclick="showPage('stuck',this)"><span class="ni">üß†</span> Brainstorming</button>
      <button class="nav-btn" data-page="templates" onclick="showPage('templates',this)"><span class="ni">üóÇ</span> Note Templates</button>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Clients</div>
    </div>
    <div class="client-items" id="clientList"></div>
    <button class="add-client" onclick="openModal('modalAddClient')">Ôºã Add Client</button>

    <div class="sidebar-footer">
      <button class="api-btn" onclick="openModal('modalApiKey')">üîë API Key Settings</button>
      <button class="change-pw-btn" onclick="openModal('modalChangePw')" style="margin-top:6px">üîí Change Password</button>
      <button class="change-pw-btn" onclick="logout()">‚Ü© Lock App</button>
      <div style="border-top:1px solid rgba(255,255,255,0.07);margin:8px 0"></div>
      <button class="data-btn" onclick="exportData(false)">üì• Export Data Backup</button>
      <button class="data-btn" onclick="document.getElementById('importInput').click()">üì§ Import Data Backup</button>
      <input type="file" id="importInput" accept=".json" style="display:none" onchange="importData(event)">
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <div>
          <div class="topbar-title" id="tbTitle">Dashboard</div>
          <div class="topbar-sub" id="tbSub">All clients overview</div>
        </div>
      </div>
      <div class="api-status">
        <div class="dot" id="apiDot"></div>
        <span id="apiStatusText">No API key</span>
      </div>
    </div>

    <div class="content">

      <!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
      <div class="page active" id="page-dashboard">
        <div id="setupBanner" class="setup-banner">
          <strong>Setup required:</strong> Add your Anthropic API key to enable AI features.
          <button class="btn btn-ghost btn-sm" style="margin-left:10px" onclick="openModal('modalApiKey')">Add Key ‚Üí</button>
        </div>
        <div id="backupBanner" style="display:none" class="backup-banner">
          <span>üíæ <strong>Time for a backup!</strong> <span id="backupDaysText"></span></span>
          <div class="backup-banner-actions">
            <button class="btn btn-sm" style="background:#f0d080;color:#7a5800;border:none;font-weight:700" onclick="exportData(true)">Download Backup</button>
            <button class="backup-dismiss" onclick="dismissBackupBanner()" title="Remind me later">√ó</button>
          </div>
        </div>
        <div id="overdueBanner"></div>

        <div id="dashEmpty" class="empty">
          <div class="empty-icon">üå±</div>
          <div class="empty-title">No clients yet</div>
          <div class="empty-text">Add your first client using the sidebar to get started.</div>
        </div>

        <div id="clientCards" class="client-cards" style="display:none"></div>

        <!-- CLIENT DETAIL (shown when client clicked from cards) -->
        <div id="clientProfile" style="display:none;margin-top:20px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
            <button class="btn btn-ghost btn-sm" onclick="showAllClients()">‚Üê All Clients</button>
          </div>
          <div class="profile-bar">
            <div class="profile-av" id="profAv"></div>
            <div>
              <div class="profile-name" id="profName"></div>
              <div class="profile-meta" id="profMeta"></div>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" onclick="switchClientTab('goals',this)">üéØ Goals</button>
            <button class="tab" onclick="switchClientTab('targets',this)">üìå Targets</button>
            <button class="tab" onclick="switchClientTab('monitoring',this)">üìä Monitoring</button>
            <button class="tab" onclick="switchClientTab('meetings',this)">üóí Meeting Log</button>
            <button class="tab" onclick="switchClientTab('notes',this)">‚úèÔ∏è Session Notes</button>
            <button class="tab" onclick="switchClientTab('strategies',this)">üí° Strategies</button>
          </div>

          <div id="ct-goals">
            <div class="btn-row" style="margin-bottom:14px">
              <button class="btn btn-primary btn-sm" onclick="openModal('modalAddGoal')">Ôºã Add Goal</button>
              <button class="btn btn-ghost btn-sm" onclick="openUploadDoc()" title="Upload a clinical document to auto-extract goals and targets">üìÑ Import from Document</button>
            </div>
            <div id="goalsList"></div>
          </div>

          <div id="ct-targets" style="display:none">
            <div class="btn-row" style="margin-bottom:14px">
              <button class="btn btn-primary btn-sm" onclick="openModal('modalAddTarget')">Ôºã Add Target</button>
            </div>
            <div style="margin-bottom:12px">
              <div class="badge badge-sage" style="margin-bottom:8px;display:inline-block">Active</div>
              <div id="targetsActive"></div>
            </div>
            <div style="margin-bottom:12px">
              <div class="badge badge-amber" style="margin-bottom:8px;display:inline-block">Mastered</div>
              <div id="targetsMastered"></div>
            </div>
            <div>
              <div class="badge" style="background:var(--surface3);color:var(--text-muted);margin-bottom:8px;display:inline-block">Discontinued</div>
              <div id="targetsDiscontinued"></div>
            </div>
          </div>

          <div id="ct-monitoring" style="display:none">
            <div class="btn-row" style="margin-bottom:14px">
              <button class="btn btn-primary btn-sm" onclick="openAddMonitor()">Ôºã Add Monitoring Item</button>
            </div>
            <div id="monitorList"></div>
          </div>

          <div id="ct-meetings" style="display:none">
            <div class="btn-row" style="margin-bottom:14px">
              <button class="btn btn-primary btn-sm" onclick="openModal('modalAddMeeting')">Ôºã Log Meeting</button>
            </div>
            <div id="meetingList"></div>
          </div>

          <div id="ct-notes" style="display:none">
            <div class="card">
              <div class="card-head">Quick Session Notes</div>
              <div class="fg">
                <label>Notes <button class="mic-btn" id="micNotes" onclick="toggleMic('noteText','micNotes')">üé§ Dictate</button></label>
                <textarea id="noteText" rows="5" placeholder="Bullet points, shorthand, stream of consciousness..."></textarea>
              </div>
              <div class="btn-row">
                <button class="btn btn-ghost btn-sm" onclick="saveClientNote()">üíæ Save Note</button>
              </div>
            </div>
            <div id="notesList"></div>
          </div>

          <div id="ct-strategies" style="display:none">
            <div class="card">
              <div class="card-head">üí° Strategies Log</div>
              <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;line-height:1.6">Save intervention ideas here ‚Äî from Brainstorming sessions or your own notes. Use this as a reference log of what's been tried or is worth trying.</p>
              <div class="btn-row" style="margin-bottom:0">
                <button class="btn btn-primary btn-sm" onclick="openAddStrategyInline()">Ôºã Add Strategy</button>
              </div>
            </div>

            <div id="addStrategyForm" style="display:none" class="card">
              <div class="card-head">New Strategy Entry</div>
              <div class="fg"><label>Title</label><input type="text" id="stratTitle" placeholder="e.g. Visual transition schedule"></div>
              <div class="fg"><label>Description / Notes</label><textarea id="stratText" rows="4" placeholder="Describe the strategy, how to implement it, or what was suggested..."></textarea></div>
              <div class="fg">
                <label>Status</label>
                <select id="stratStatus">
                  <option value="trying">üîÑ Trying / To Try</option>
                  <option value="worked">‚úÖ Worked</option>
                  <option value="didnt-work">‚ùå Didn't Work</option>
                </select>
              </div>
              <div class="btn-row">
                <button class="btn btn-ghost btn-sm" onclick="closeAddStrategyInline()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="saveStrategy()">Save Strategy</button>
              </div>
            </div>

            <div id="strategiesList"></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê BIP ‚ïê‚ïê -->
      <div class="page" id="page-bip">

        <!-- Client context bar -->
        <div class="ctx-bar" id="bipCtxBar">
          <div class="ctx-bar-label">üë§ Client</div>
          <select id="bipClientSelect" onchange="updateGeneratorContext('bip')">
            <option value="">‚Äî No client selected ‚Äî</option>
          </select>
          <label class="ctx-toggle">
            <input type="checkbox" id="bipCtxToggle" checked onchange="updateGeneratorContext('bip')">
            Include profile context
          </label>
          <div class="ctx-summary" id="bipCtxSummary">No client selected.</div>
        </div>

        <div class="card">
          <div class="card-head">BIP Generator <span class="badge badge-sage">Behavior Intervention Plan</span></div>
          <div class="fg2">
            <div class="fg"><label>Client Initials</label><input type="text" id="bipClient" placeholder="e.g. JaDo"></div>
            <div class="fg"><label>Behavior Name</label><input type="text" id="bipBehavior" placeholder="e.g. Elopement, Aggression"></div>
          </div>
          <div class="fg">
            <label>Describe the behavior <button class="mic-btn" id="micBip" onclick="toggleMic('bipDesc','micBip')">üé§ Dictate</button></label>
            <textarea id="bipDesc" rows="4" placeholder="How it starts, what it looks like, how it ends. Include context, antecedents you've noticed, what happens after..."></textarea>
          </div>
          <div class="fg2">
            <div class="fg"><label>Hypothesized Function (optional)</label><input type="text" id="bipFunction" placeholder="e.g. Escape, Attention ‚Äî leave blank to derive"></div>
            <div class="fg"><label>Known Reinforcers</label><input type="text" id="bipReinf" placeholder="e.g. Tangibles, verbal praise, iPad"></div>
          </div>
          <div class="fg"><label>Additional Context (optional)</label><textarea id="bipContext" rows="2" placeholder="e.g. Increases during transitions. Limited vocal communication..."></textarea></div>
          <div class="btn-row">
            <button class="btn btn-primary" id="bipGenBtn" onclick="generateBIP()" disabled>‚ú® Generate BIP Draft</button>
          </div>
        </div>

        <div id="bipOutput" style="display:none">
          <div class="card">
            <div class="card-head">BIP Draft <span class="badge badge-terra" id="bipClientBadge"></span></div>
            <div class="alert-amber no-print">‚ö†Ô∏è Review carefully. Verify function matches assessment. Edit before finalizing.</div>
            <div class="tsec"><button class="tsec-head" onclick="toggleTsec('bip-behavior')">Behavior Definition <span>‚ñæ</span></button><div class="tsec-body" id="bip-behavior"></div><div style="padding:6px 14px 10px;display:flex;justify-content:flex-end"><button class="rbt-field-copy" onclick="copySection('bip-behavior','Behavior Definition')">üìã Copy section</button></div></div>
            <div class="tsec"><button class="tsec-head" onclick="toggleTsec('bip-function')">Function <span>‚ñæ</span></button><div class="tsec-body" id="bip-function"></div><div style="padding:6px 14px 10px;display:flex;justify-content:flex-end"><button class="rbt-field-copy" onclick="copySection('bip-function','Function')">üìã Copy section</button></div></div>
            <div class="tsec"><button class="tsec-head" onclick="toggleTsec('bip-antecedents')">Antecedents <span>‚ñæ</span></button><div class="tsec-body" id="bip-antecedents"></div><div style="padding:6px 14px 10px;display:flex;justify-content:flex-end"><button class="rbt-field-copy" onclick="copySection('bip-antecedents','Antecedents')">üìã Copy section</button></div></div>
            <div class="tsec"><button class="tsec-head" onclick="toggleTsec('bip-reinforcers')">Reinforcers <span>‚ñæ</span></button><div class="tsec-body" id="bip-reinforcers"></div><div style="padding:6px 14px 10px;display:flex;justify-content:flex-end"><button class="rbt-field-copy" onclick="copySection('bip-reinforcers','Reinforcers')">üìã Copy section</button></div></div>
            <div class="tsec"><button class="tsec-head" onclick="toggleTsec('bip-proactive')">Proactive Strategies <span>‚ñæ</span></button><div class="tsec-body" id="bip-proactive"></div><div style="padding:6px 14px 10px;display:flex;justify-content:flex-end"><button class="rbt-field-copy" onclick="copySection('bip-proactive','Proactive Strategies')">üìã Copy section</button></div></div>
            <div class="tsec"><button class="tsec-head" onclick="toggleTsec('bip-reactive')">Reactive Strategies <span>‚ñæ</span></button><div class="tsec-body" id="bip-reactive"></div><div style="padding:6px 14px 10px;display:flex;justify-content:flex-end"><button class="rbt-field-copy" onclick="copySection('bip-reactive','Reactive Strategies')">üìã Copy section</button></div></div>
            <div class="btn-row">
              <button class="btn btn-ghost btn-sm" onclick="copyEl('bipFullText')">üìã Copy All</button>
              <button class="btn btn-cr btn-sm" onclick="copyBIPForCR()">üìã Copy for Central Reach</button>
              <button class="btn btn-sage btn-sm" onclick="printBIP()">üñ®Ô∏è Print / PDF</button>
            </div>
            <div id="bipFullText" style="display:none"></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê RBT ‚ïê‚ïê -->
      <div class="page" id="page-rbt">

        <!-- Client context bar -->
        <div class="ctx-bar" id="rbtCtxBar">
          <div class="ctx-bar-label">üë§ Client</div>
          <select id="rbtClientSelect" onchange="updateGeneratorContext('rbt')">
            <option value="">‚Äî No client selected ‚Äî</option>
          </select>
          <label class="ctx-toggle">
            <input type="checkbox" id="rbtCtxToggle" checked onchange="updateGeneratorContext('rbt')">
            Include profile context
          </label>
          <div class="ctx-summary" id="rbtCtxSummary">No client selected.</div>
        </div>

        <div class="card">
          <div class="card-head">RBT Program Sheet Generator</div>
          <div class="fg2">
            <div class="fg"><label>Client Initials</label><input type="text" id="rbtClient" placeholder="e.g. JaDo"></div>
            <div class="fg"><label>Target Name</label><input type="text" id="rbtTarget" placeholder="e.g. Imitate clap hands"></div>
          </div>
          <div class="fg">
            <label>Describe the target skill <button class="mic-btn" id="micRbt" onclick="toggleMic('rbtDesc','micRbt')">üé§ Dictate</button></label>
            <textarea id="rbtDesc" rows="3" placeholder="What the client needs to learn, how it will be taught, any relevant context..."></textarea>
          </div>
          <div class="fg2">
            <div class="fg"><label>Known Reinforcers</label><input type="text" id="rbtReinf" placeholder="e.g. Tangibles, verbal praise"></div>
            <div class="fg"><label>Prompting Strategies</label><input type="text" id="rbtPrompts" placeholder="e.g. Full physical, partial physical, gestural"></div>
          </div>
          <div class="fg2">
            <div class="fg"><label>Environment / Context</label>
              <select id="rbtEnv"><option>NET or DTT</option><option>NET only</option><option>DTT only</option><option>Natural environment only</option></select>
            </div>
            <div class="fg"><label>Target Presentation</label>
              <select id="rbtPresentation"><option>Interspersed</option><option>Blocked</option><option>Random rotation</option></select>
            </div>
          </div>
          <div class="fg"><label>Additional Notes (optional)</label><input type="text" id="rbtNotes" placeholder="e.g. Can be done anywhere anytime."></div>
          <div class="btn-row">
            <button class="btn btn-primary" id="rbtGenBtn" onclick="generateRBT()" disabled>‚ú® Generate Program Sheet</button>
          </div>
        </div>

        <div id="rbtOutput" style="display:none">
          <div class="card">
            <div class="card-head">Program Sheet <span class="badge badge-slate" id="rbtClientBadge"></span></div>
            <p style="font-size:13px;color:var(--text-muted);margin-bottom:4px">Each field has its own copy button ‚Äî paste directly into the matching field in Central Reach.</p>
            <div class="rbt-fields-wrap" id="rbtFieldsWrap"></div>
            <div class="btn-row">
              <button class="btn btn-ghost btn-sm" onclick="copyText('rbtRawHidden')">üìã Copy All</button>
              <button class="btn btn-cr btn-sm" onclick="copyText('rbtRawHidden')">üìã Copy for Central Reach</button>
              <button class="btn btn-sage btn-sm" onclick="printRBT()">üñ®Ô∏è Print / PDF</button>
              <button class="btn btn-ghost btn-sm" onclick="addAnotherRBT()">Ôºã Another Target</button>
            </div>
            <div id="rbtRawHidden" style="display:none"></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PARENT TRAINING ‚ïê‚ïê -->
      <div class="page" id="page-parent">

        <!-- Client context bar -->
        <div class="ctx-bar" id="parentCtxBar">
          <div class="ctx-bar-label">üë§ Client</div>
          <select id="parentClientSelect" onchange="updateGeneratorContext('parent')">
            <option value="">‚Äî No client selected ‚Äî</option>
          </select>
          <label class="ctx-toggle">
            <input type="checkbox" id="parentCtxToggle" checked onchange="updateGeneratorContext('parent')">
            Include profile context
          </label>
          <div class="ctx-summary" id="parentCtxSummary">No client selected.</div>
        </div>

        <div class="tabs">
          <button class="tab active" onclick="switchParentTab('prep',this)">üìã Pre-Meeting Prep</button>
          <button class="tab" onclick="switchParentTab('guide',this)">üì± During-Meeting Guide</button>
          <button class="tab" onclick="switchParentTab('handout',this)">üìÑ Parent Handout</button>
        </div>

        <div id="pt-prep">
          <div class="card">
            <div class="card-head">Pre-Meeting Agenda</div>
            <div class="fg2">
              <div class="fg"><label>Client Initials</label><input type="text" id="prepClient" placeholder="e.g. JaDo"></div>
              <div class="fg"><label>Meeting Date</label><input type="text" id="prepDate" placeholder="e.g. 2/26/2025"></div>
            </div>
            <div class="fg">
              <label>What to cover <button class="mic-btn" id="micPrep" onclick="toggleMic('prepTopics','micPrep')">üé§ Dictate</button></label>
              <textarea id="prepTopics" rows="3" placeholder="e.g. Follow up on sleep goal. Review token economy. Introduce new transition strategy."></textarea>
            </div>
            <div class="fg"><label>Last meeting follow-up items (optional)</label><textarea id="prepFollowup" rows="2" placeholder="e.g. Family trying visual schedule at home. Check in on whining during transitions."></textarea></div>
            <div class="btn-row">
              <button class="btn btn-primary" id="prepGenBtn" onclick="generatePrep()" disabled>‚ú® Generate Agenda</button>
            </div>
          </div>
          <div id="prepOutput" style="display:none">
            <div class="card">
              <div class="card-head">Pre-Meeting Agenda</div>
              <div class="output" id="prepResult"></div>
              <div class="out-actions">
                <button class="btn btn-ghost btn-sm" onclick="copyText('prepResult')">üìã Copy</button>
                <button class="btn btn-sage btn-sm" onclick="printEl('prepResult','Pre-Meeting Agenda')">üñ®Ô∏è Print</button>
              </div>
            </div>
          </div>
        </div>

        <div id="pt-guide" style="display:none">
          <div class="card">
            <div class="card-head">During-Meeting Guide</div>
            <div class="fg2">
              <div class="fg"><label>Client Initials</label><input type="text" id="guideClient" placeholder="e.g. JaDo"></div>
              <div class="fg"><label>Session Focus</label><input type="text" id="guideFocus" placeholder="e.g. Sleep goal, transitions"></div>
            </div>
            <div class="fg"><label>Goals / behaviors to discuss <button class="mic-btn" id="micGuide" onclick="toggleMic('guideGoals','micGuide')">üé§ Dictate</button></label>
              <textarea id="guideGoals" rows="3" placeholder="e.g. Sleep independence step 2. Elopement at home. Parent asking about potty training."></textarea>
            </div>
            <div class="fg"><label>Family updates or concerns</label><textarea id="guideConcerns" rows="2" placeholder="e.g. New sibling arriving. Only mom today."></textarea></div>
            <div class="btn-row">
              <button class="btn btn-primary" id="guideGenBtn" onclick="generateGuide()" disabled>‚ú® Generate Meeting Guide</button>
            </div>
          </div>
          <div id="guideOutput" style="display:none">
            <div class="card">
              <div class="card-head">During-Meeting Guide <span class="badge badge-amber">Keep open during session</span></div>
              <div class="output" id="guideResult"></div>
              <div class="out-actions">
                <button class="btn btn-ghost btn-sm" onclick="copyText('guideResult')">üìã Copy</button>
              </div>
            </div>
          </div>
        </div>

        <div id="pt-handout" style="display:none">
          <div class="card">
            <div class="card-head">Parent Handout</div>
            <div class="fg2">
              <div class="fg"><label>Client Initials</label><input type="text" id="handoutClient" placeholder="e.g. JaDo"></div>
              <div class="fg"><label>Topic</label><input type="text" id="handoutTopic" placeholder="e.g. Toilet training, Token economy"></div>
            </div>
            <div class="fg"><label>Strategies to include <button class="mic-btn" id="micHandout" onclick="toggleMic('handoutStrats','micHandout')">üé§ Dictate</button></label>
              <textarea id="handoutStrats" rows="3" placeholder="e.g. Use visual schedule. Offer choice board. Reinforce with praise and stickers."></textarea>
            </div>
            <div class="fg"><label>Data collection instructions</label><input type="text" id="handoutData" placeholder="e.g. Record each incident with time and antecedent"></div>
            <div class="btn-row">
              <button class="btn btn-primary" id="handoutGenBtn" onclick="generateHandout()" disabled>‚ú® Generate Handout</button>
            </div>
          </div>
          <div id="handoutOutput" style="display:none">
            <div class="card">
              <div class="card-head">Parent Handout</div>
              <div class="output" id="handoutResult"></div>
              <div class="out-actions">
                <button class="btn btn-ghost btn-sm" onclick="copyText('handoutResult')">üìã Copy</button>
                <button class="btn btn-sage btn-sm" onclick="printEl('handoutResult','Parent Handout')">üñ®Ô∏è Print / PDF</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê I'M STUCK ‚ïê‚ïê -->
      <div class="page" id="page-stuck">

        <!-- Client context bar -->
        <div class="ctx-bar" id="stuckCtxBar">
          <div class="ctx-bar-label">üë§ Client</div>
          <select id="stuckClientSelect" onchange="updateStuckContext()">
            <option value="">‚Äî No client selected ‚Äî</option>
          </select>
          <label class="ctx-toggle">
            <input type="checkbox" id="stuckCtxToggle" checked onchange="updateStuckContext()">
            Include profile context
          </label>
          <div class="ctx-summary" id="stuckCtxSummary">No client selected ‚Äî AI will answer general ABA questions.</div>
        </div>

        <div class="card" style="margin-bottom:10px">
          <div class="card-head">üß† Brainstorming <span class="badge badge-sage">Clinical Brainstorm</span></div>
          <p style="font-size:14px;color:var(--text-muted);margin-bottom:8px">Describe a situation and brainstorm ideas together. Context carries through the conversation.</p>
          <div style="display:flex;justify-content:flex-end">
            <button class="btn btn-ghost btn-sm" onclick="clearChat()">üóë Clear conversation</button>
          </div>
        </div>

        <div class="chat-wrap">
          <div class="chat-messages" id="chatMessages">
            <div class="msg msg-ai">
              <div class="msg-label">BCBA Assistant</div>
              Tell me what's going on. Describe the behavior, the context, what you've tried, and what isn't working. The more detail you give me, the more useful I can be. üíö
            </div>
          </div>
          <div class="chat-input-row">
            <textarea id="chatInput" rows="2" placeholder="What are you working through?" onkeydown="chatKeydown(event)"></textarea>
            <div style="display:flex;flex-direction:column;gap:6px">
              <button class="mic-btn" id="micChat" onclick="toggleMic('chatInput','micChat')" style="height:46px;padding:0 12px">üé§</button>
              <button class="btn btn-primary btn-sm" id="chatSendBtn" onclick="sendChat()" disabled style="height:46px">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê NOTE TEMPLATES ‚ïê‚ïê -->
      <div class="page" id="page-templates">
        <div class="card">
          <div class="card-head">Session Note Templates</div>
          <p style="font-size:14px;color:var(--text-muted);margin-bottom:14px">A personal library of reusable phrases for Central Reach. Select multiple templates and copy them together as a block.</p>
          <div class="btn-row">
            <button class="btn btn-primary btn-sm" onclick="openAddTemplateInline()">Ôºã Add Template</button>
            <button class="btn btn-ghost btn-sm" id="genTemplatesBtn" onclick="generateDefaultTemplates()" disabled>‚ú® Generate Suggestions</button>
            <button class="btn btn-sage btn-sm" id="copySelectedBtn" onclick="copySelectedTemplates()" style="display:none">üìã Copy Selected (<span id="selectedCount">0</span>)</button>
            <button class="btn btn-ghost btn-sm" onclick="clearSelection()">Clear Selection</button>
          </div>
        </div>

        <!-- Add template inline form -->
        <div id="addTemplateForm" style="display:none" class="card">
          <div class="card-head">New Template</div>
          <div class="fg"><label>Title</label><input type="text" id="tplTitle" placeholder="e.g. Supported RBT with transition"></div>
          <div class="fg"><label>Template Text</label><textarea id="tplText" rows="3" placeholder="e.g. Supported RBT during transition from [activity] to [activity]. Client demonstrated [behavior]."></textarea></div>
          <div class="btn-row">
            <button class="btn btn-ghost btn-sm" onclick="closeAddTemplate()">Cancel</button>
            <button class="btn btn-primary btn-sm" onclick="saveTemplate()">Save Template</button>
          </div>
        </div>

        <div id="templatesList"></div>
      </div>

    </div>
  </main>
</div>

<div class="print-area" id="printArea"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COPY HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copySection(elId, label) {
  const text = document.getElementById(elId).textContent.trim();
  navigator.clipboard.writeText(text).then(() => {
    // Brief visual feedback on the button
    const btns = document.querySelectorAll('.rbt-field-copy');
    btns.forEach(b => { if (b.getAttribute('onclick')?.includes(elId)) { const orig = b.textContent; b.textContent = '‚úì Copied!'; setTimeout(() => b.textContent = orig, 1500); } });
  });
}

function copyBIPForCR() {
  const sections = [
    ['Behavior Definition', 'bip-behavior'],
    ['Function', 'bip-function'],
    ['Antecedents', 'bip-antecedents'],
    ['Reinforcers', 'bip-reinforcers'],
    ['Proactive Strategies', 'bip-proactive'],
    ['Reactive Strategies', 'bip-reactive']
  ];
  const text = sections.map(([label, id]) => {
    const content = document.getElementById(id).textContent.trim();
    return `${label.toUpperCase()}\n${content}`;
  }).join('\n\n');
  navigator.clipboard.writeText(text).then(() => alert('BIP copied for Central Reach! ‚úì\nPaste it into the notes or BIP field in CR.'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RBT FIELD-BY-FIELD RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RBT_FIELDS = [
  'Procedures/Other Notes',
  'SD',
  'Definition of desired behavior / correct response',
  'Stimuli Presentation',
  'Materials',
  'Prompting Strategies',
  'Definition for Undesired Target Behaviors',
  'Error Correction Procedure',
  'Reinforcement',
  'Environment/Context',
  'Target Presentation',
  'Trials'
];

function renderRBTFields(rawText) {
  const wrap = document.getElementById('rbtFieldsWrap');
  const lines = rawText.split('\n');
  const parsed = {};
  let currentField = null;
  let currentVal = [];

  lines.forEach(line => {
    const matchedField = RBT_FIELDS.find(f => line.startsWith(f + ':'));
    if (matchedField) {
      if (currentField) parsed[currentField] = currentVal.join('\n').trim();
      currentField = matchedField;
      currentVal = [line.slice(matchedField.length + 1).trim()];
    } else if (currentField) {
      currentVal.push(line);
    }
  });
  if (currentField) parsed[currentField] = currentVal.join('\n').trim();

  wrap.innerHTML = RBT_FIELDS.map(field => {
    const val = parsed[field] || '‚Äî';
    const fieldId = 'rbtf_' + field.replace(/[^a-z0-9]/gi, '_');
    return `<div class="rbt-field">
      <div class="rbt-field-label">${field}</div>
      <div class="rbt-field-value" id="${fieldId}">${val}</div>
      <button class="rbt-field-copy" onclick="copyFieldValue('${fieldId}', this)">üìã Copy</button>
    </div>`;
  }).join('');

  // Store raw text for Copy All
  document.getElementById('rbtRawHidden').textContent = rawText;
}

function copyFieldValue(elId, btn) {
  const text = document.getElementById(elId).textContent.trim();
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!';
    btn.style.background = 'var(--sage-light)';
    btn.style.color = 'var(--sage-dark)';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; btn.style.color = ''; }, 1500);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOCUMENT UPLOAD & EXTRACTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let extractedDocData = null;

function openUploadDoc() {
  if (!activeClientId) { alert('Please select a client first.'); return; }
  if (!S.apiKey) { alert('Please add your API key first.'); openModal('modalApiKey'); return; }
  document.getElementById('docUploadInput').value = '';
  document.getElementById('docUploadContext').value = '';
  document.getElementById('docUploadError').style.display = 'none';
  openModal('modalUploadDoc');
}

async function processDocumentUpload() {
  const fileInput = document.getElementById('docUploadInput');
  const context = document.getElementById('docUploadContext').value.trim();
  const errEl = document.getElementById('docUploadError');
  const btn = document.getElementById('docUploadBtn');

  if (!fileInput.files.length) { errEl.textContent = 'Please select a file.'; errEl.style.display = 'block'; return; }

  const file = fileInput.files[0];
  const maxSize = 5 * 1024 * 1024; // 5MB
  if (file.size > maxSize) { errEl.textContent = 'File is too large. Please use a file under 5MB.'; errEl.style.display = 'block'; return; }

  errEl.style.display = 'none';
  btn.innerHTML = '<span class="ld"><span></span><span></span><span></span></span> Reading document‚Ä¶';
  btn.disabled = true;

  try {
    const base64 = await fileToBase64(file);
    const isImage = file.type.startsWith('image/');
    const isPDF = file.type === 'application/pdf';

    if (!isImage && !isPDF) {
      errEl.textContent = 'Please upload a PDF or image file (JPG, PNG, HEIC).';
      errEl.style.display = 'block';
      btn.innerHTML = 'üìÑ Read Document'; btn.disabled = false;
      return;
    }

    const mediaType = isPDF ? 'application/pdf' : file.type;
    const docType = isPDF ? 'document' : 'image';

    const prompt = `You are helping a BCBA extract clinical information from a document to populate a client profile in a therapy management tool.

${context ? 'Context provided: ' + context : ''}

Please extract ALL of the following from this document and return ONLY valid JSON in this exact format:
{
  "goals": [
    {
      "main": "Main goal name",
      "subs": ["sub-goal 1", "sub-goal 2"]
    }
  ],
  "targets": [
    {
      "name": "Target name",
      "status": "active",
      "notes": "any relevant notes"
    }
  ],
  "behaviors": [
    {
      "name": "Behavior name",
      "notes": "brief description if available"
    }
  ],
  "reinforcers": "comma separated list of reinforcers if found"
}

Rules:
- status must be "active", "mastered", or "discontinued"
- If you cannot find goals, return an empty array
- If you cannot find targets, return an empty array  
- Extract as much as you can find ‚Äî be thorough
- Return ONLY the JSON object, no other text`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': S.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        messages: [{
          role: 'user',
          content: [
            {
              type: docType,
              source: { type: 'base64', media_type: mediaType, data: base64 }
            },
            { type: 'text', text: prompt }
          ]
        }]
      })
    });

    if (!response.ok) {
      const e = await response.json().catch(() => {});
      throw new Error(e?.error?.message || 'API error ' + response.status);
    }

    const data = await response.json();
    const text = data.content?.[0]?.text || '';
    const clean = text.replace(/```json|```/g, '').trim();
    extractedDocData = JSON.parse(clean);

    btn.innerHTML = 'üìÑ Read Document'; btn.disabled = false;
    closeModal('modalUploadDoc');
    showDocReview(extractedDocData);

  } catch(err) {
    errEl.textContent = 'Error reading document: ' + err.message;
    errEl.style.display = 'block';
    btn.innerHTML = 'üìÑ Read Document'; btn.disabled = false;
  }
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = () => reject(new Error('Could not read file'));
    reader.readAsDataURL(file);
  });
}

function showDocReview(data) {
  const content = document.getElementById('docReviewContent');
  let html = '';

  // Goals
  if (data.goals?.length) {
    html += `<div class="review-section">
      <div class="review-section-head">üéØ Goals Found (${data.goals.length})</div>`;
    data.goals.forEach((g, gi) => {
      html += `<div class="review-item">
        <input type="checkbox" checked id="goal_check_${gi}">
        <div style="flex:1">
          <div contenteditable="true" class="review-item-text" id="goal_main_${gi}" style="font-weight:700">${escapeHtml(g.main)}</div>
          ${g.subs.map((s, si) => `<div style="display:flex;align-items:center;gap:8px;margin-top:4px">
            <input type="checkbox" checked id="sub_check_${gi}_${si}" style="margin-left:16px">
            <div contenteditable="true" class="review-item-text" id="sub_${gi}_${si}" style="color:var(--text-mid)">${escapeHtml(s)}</div>
          </div>`).join('')}
        </div>
      </div>`;
    });
    html += '</div>';
  } else {
    html += `<div class="review-section"><div class="review-section-head">üéØ Goals ‚Äî None found</div></div>`;
  }

  // Targets
  if (data.targets?.length) {
    html += `<div class="review-section">
      <div class="review-section-head">üìå Targets Found (${data.targets.length})</div>`;
    data.targets.forEach((t, ti) => {
      html += `<div class="review-item">
        <input type="checkbox" checked id="target_check_${ti}">
        <div style="flex:1">
          <div contenteditable="true" class="review-item-text" id="target_name_${ti}" style="font-weight:600">${escapeHtml(t.name)}</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:2px">${t.status}${t.notes ? ' ¬∑ ' + t.notes : ''}</div>
        </div>
      </div>`;
    });
    html += '</div>';
  }

  // Behaviors
  if (data.behaviors?.length) {
    html += `<div class="review-section">
      <div class="review-section-head">‚ö†Ô∏è Behaviors Found (${data.behaviors.length}) ‚Äî will be added as targets</div>`;
    data.behaviors.forEach((b, bi) => {
      html += `<div class="review-item">
        <input type="checkbox" checked id="behavior_check_${bi}">
        <div contenteditable="true" class="review-item-text" id="behavior_name_${bi}" style="flex:1;font-weight:600">${escapeHtml(b.name)}</div>
      </div>`;
    });
    html += '</div>';
  }

  // Reinforcers note
  if (data.reinforcers) {
    html += `<div style="background:var(--sage-light);border-radius:10px;padding:12px 14px;font-size:13px;color:var(--sage-dark);margin-bottom:8px">
      <strong>Reinforcers found:</strong> ${escapeHtml(data.reinforcers)}<br>
      <span style="font-size:12px;opacity:0.8">These will be noted ‚Äî you can add them manually to BIP/RBT fields.</span>
    </div>`;
  }

  if (!data.goals?.length && !data.targets?.length && !data.behaviors?.length) {
    html = `<div class="empty"><div class="empty-icon">ü§î</div><div class="empty-title">Nothing found</div><div class="empty-text">The document didn't appear to contain recognizable goals or targets. Try a different document or add context about what type of document it is.</div></div>`;
  }

  content.innerHTML = html;
  openModal('modalDocReview');
}

function saveExtractedData() {
  const client = getClient(activeClientId);
  if (!client || !extractedDocData) return;

  let goalsAdded = 0, targetsAdded = 0;

  // Save checked goals
  (extractedDocData.goals || []).forEach((g, gi) => {
    const checked = document.getElementById('goal_check_' + gi)?.checked;
    if (!checked) return;
    const mainEl = document.getElementById('goal_main_' + gi);
    const main = mainEl?.textContent.trim() || g.main;
    const subs = (g.subs || []).map((s, si) => {
      const subChecked = document.getElementById(`sub_check_${gi}_${si}`)?.checked;
      if (!subChecked) return null;
      const subEl = document.getElementById(`sub_${gi}_${si}`);
      return { id: Date.now().toString() + Math.random(), text: subEl?.textContent.trim() || s, done: false };
    }).filter(Boolean);
    client.goals.push({ id: Date.now().toString() + Math.random(), main, subs });
    goalsAdded++;
  });

  // Save checked targets
  (extractedDocData.targets || []).forEach((t, ti) => {
    const checked = document.getElementById('target_check_' + ti)?.checked;
    if (!checked) return;
    const nameEl = document.getElementById('target_name_' + ti);
    const name = nameEl?.textContent.trim() || t.name;
    client.targets.push({ id: Date.now().toString() + Math.random(), name, status: t.status || 'active', notes: t.notes || '' });
    targetsAdded++;
  });

  // Save checked behaviors as targets
  (extractedDocData.behaviors || []).forEach((b, bi) => {
    const checked = document.getElementById('behavior_check_' + bi)?.checked;
    if (!checked) return;
    const nameEl = document.getElementById('behavior_name_' + bi);
    const name = nameEl?.textContent.trim() || b.name;
    client.targets.push({ id: Date.now().toString() + Math.random(), name, status: 'active', notes: 'Imported from document' });
    targetsAdded++;
  });

  saveState();
  renderGoals(client);
  renderTargets(client);
  closeModal('modalDocReview');
  extractedDocData = null;
  alert(`‚úì Saved! ${goalsAdded} goal${goalsAdded !== 1 ? 's' : ''} and ${targetsAdded} target${targetsAdded !== 1 ? 's' : ''} added to ${client.initials}'s profile.`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT / BACKUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportData(fromBanner) {
  const payload = {
    version: 5,
    exportedAt: new Date().toISOString(),
    clients: S.clients,
    templates: S.templates
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toLocaleDateString('en-US').replace(/\//g, '-');
  a.href = url;
  a.download = `bcba-backup-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);

  // Record export time and reset banner
  localStorage.setItem('bcba3_lastExport', Date.now().toString());
  hideBanner('backupBanner');
  if (fromBanner) alert('Backup downloaded! ‚úì Save it somewhere safe like iCloud Drive or your Downloads folder.');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.clients && !data.templates) { alert('This file doesn\'t look like a valid BCBA Assistant backup.'); return; }
      if (!confirm(`This will replace all current data with the backup from ${new Date(data.exportedAt).toLocaleDateString()}.\n\nAre you sure? This cannot be undone.`)) return;
      if (data.clients) S.clients = data.clients;
      if (data.templates) S.templates = data.templates;
      saveState();
      renderClients();
      renderTemplates();
      renderDashboard();
      activeClientId = null;
      alert('Data restored successfully! ‚úì');
    } catch(err) {
      alert('Could not read the backup file. Make sure it\'s a valid .json export from this app.');
    }
  };
  reader.readAsText(file);
  // Reset the input so the same file can be re-imported if needed
  event.target.value = '';
}

function checkBackupReminder() {
  const lastExport = localStorage.getItem('bcba3_lastExport');
  const dismissed = sessionStorage.getItem('bcba3_backupDismissed');
  if (dismissed) return; // Already dismissed this session

  const banner = document.getElementById('backupBanner');
  const daysText = document.getElementById('backupDaysText');

  if (!lastExport) {
    // Never backed up ‚Äî show if they have any client data
    if (S.clients.length > 0) {
      daysText.textContent = "You haven't backed up your data yet.";
      banner.style.display = 'flex';
    }
    return;
  }

  const daysSince = Math.floor((Date.now() - parseInt(lastExport)) / 86400000);
  if (daysSince >= 7) {
    daysText.textContent = `Last backup was ${daysSince} day${daysSince !== 1 ? 's' : ''} ago.`;
    banner.style.display = 'flex';
  }
}

function dismissBackupBanner() {
  // Dismiss for this session only ‚Äî will reappear next time they open the app
  sessionStorage.setItem('bcba3_backupDismissed', '1');
  hideBanner('backupBanner');
}

function hideBanner(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT CONTEXT FOR AI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildClientContext(clientId) {
  const client = getClient(clientId);
  if (!client) return null;
  const lines = [`CLIENT PROFILE ‚Äî ${client.initials}`];

  if (client.goals?.length) {
    lines.push('\nGOALS:');
    client.goals.forEach(g => {
      lines.push(`  ‚Ä¢ ${g.main}`);
      g.subs?.forEach(s => lines.push(`    ‚Ü≥ ${s.text}${s.done ? ' [completed]' : ''}`));
    });
  }

  const active = client.targets?.filter(t => t.status === 'active') || [];
  if (active.length) {
    lines.push('\nACTIVE TARGETS:');
    active.forEach(t => lines.push(`  ‚Ä¢ ${t.name}${t.notes ? ' ‚Äî ' + t.notes : ''}`));
  }

  const mastered = client.targets?.filter(t => t.status === 'mastered') || [];
  if (mastered.length) {
    lines.push('\nMASTERED TARGETS:');
    mastered.forEach(t => lines.push(`  ‚Ä¢ ${t.name}`));
  }

  const disc = client.targets?.filter(t => t.status === 'discontinued') || [];
  if (disc.length) {
    lines.push('\nDISCONTINUED TARGETS:');
    disc.forEach(t => lines.push(`  ‚Ä¢ ${t.name}${t.notes ? ' ‚Äî ' + t.notes : ''}`));
  }

  const meetings = client.meetings?.slice(0, 3) || [];
  if (meetings.length) {
    lines.push('\nRECENT PARENT MEETINGS:');
    meetings.forEach(m => {
      lines.push(`  ${m.date || 'No date'}: ${m.topics?.substring(0, 120) || ''}${m.topics?.length > 120 ? '‚Ä¶' : ''}`);
      if (m.followup) lines.push(`    Follow-up: ${m.followup.substring(0, 80)}`);
    });
  }

  const notes = client.notes?.slice(0, 2) || [];
  if (notes.length) {
    lines.push('\nRECENT SESSION NOTES:');
    notes.forEach(n => lines.push(`  ${n.date}: ${n.text?.substring(0, 150) || ''}${n.text?.length > 150 ? '‚Ä¶' : ''}`));
  }

  return lines.join('\n');
}

function getContextSummary(client) {
  if (!client) return 'No client selected.';
  const goalCount = client.goals?.length || 0;
  const activeTargets = client.targets?.filter(t => t.status === 'active').length || 0;
  const lastMeeting = client.meetings?.[0]?.date;
  const parts = [];
  if (goalCount) parts.push(`${goalCount} goal${goalCount !== 1 ? 's' : ''}`);
  if (activeTargets) parts.push(`${activeTargets} active target${activeTargets !== 1 ? 's' : ''}`);
  if (lastMeeting) parts.push(`last meeting ${lastMeeting}`);
  return parts.length
    ? `<strong>${client.initials}</strong> ‚Äî ${parts.join(' ¬∑ ')} ‚Äî profile loaded`
    : `<strong>${client.initials}</strong> ‚Äî profile loaded (no data yet)`;
}

function populateContextDropdowns() {
  const dropdowns = ['stuckClientSelect','bipClientSelect','rbtClientSelect','parentClientSelect'];
  dropdowns.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">‚Äî No client selected ‚Äî</option>' +
      S.clients.map(c => `<option value="${c.id}">${c.initials}</option>`).join('');
    if (current && S.clients.find(c => c.id === current)) {
      sel.value = current;
    } else if (activeClientId) {
      sel.value = activeClientId;
    }
  });
  updateStuckContext();
  updateGeneratorContext('bip');
  updateGeneratorContext('rbt');
  updateGeneratorContext('parent');
}

function updateStuckContext() {
  const sel = document.getElementById('stuckClientSelect');
  const toggle = document.getElementById('stuckCtxToggle');
  const summary = document.getElementById('stuckCtxSummary');
  const bar = document.getElementById('stuckCtxBar');
  if (!sel || !toggle || !summary) return;
  const clientId = sel.value;
  const on = toggle.checked && !!clientId;
  const client = clientId ? getClient(clientId) : null;
  bar.className = 'ctx-bar ' + (on ? 'has-client' : 'no-client');
  summary.innerHTML = on
    ? getContextSummary(client)
    : clientId
      ? `<span style="color:var(--text-muted)">Profile context off ‚Äî AI will answer generally.</span>`
      : 'No client selected ‚Äî AI will answer general ABA questions.';
}

function updateGeneratorContext(page) {
  const sel = document.getElementById(page + 'ClientSelect');
  const toggle = document.getElementById(page + 'CtxToggle');
  const summary = document.getElementById(page + 'CtxSummary');
  const bar = document.getElementById(page + 'CtxBar');
  if (!sel || !toggle || !summary) return;
  const clientId = sel.value;
  const on = toggle.checked && !!clientId;
  const client = clientId ? getClient(clientId) : null;
  bar.className = 'ctx-bar ' + (on ? 'has-client' : 'no-client');
  summary.innerHTML = on
    ? getContextSummary(client)
    : clientId
      ? `<span style="color:var(--text-muted)">Profile context off ‚Äî generating without client data.</span>`
      : 'No client selected.';
  // Auto-fill initials
  if (client) {
    const map = { bip: ['bipClient'], rbt: ['rbtClient'], parent: ['prepClient','guideClient','handoutClient'] };
    (map[page] || []).forEach(f => { const el = document.getElementById(f); if (el) el.value = client.initials; });
  }
}

function getSelectedContext(page) {
  const selId = page === 'stuck' ? 'stuckClientSelect' : page + 'ClientSelect';
  const toggleId = page === 'stuck' ? 'stuckCtxToggle' : page + 'CtxToggle';
  const sel = document.getElementById(selId);
  const toggle = document.getElementById(toggleId);
  if (!sel || !toggle || !toggle.checked || !sel.value) return null;
  return buildClientContext(sel.value);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-FILL (now just triggers context update)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoFillInitials() {
  ['stuckClientSelect','bipClientSelect','rbtClientSelect','parentClientSelect'].forEach(id => {
    const el = document.getElementById(id);
    if (el && activeClientId) el.value = activeClientId;
  });
  updateStuckContext();
  updateGeneratorContext('bip');
  updateGeneratorContext('rbt');
  updateGeneratorContext('parent');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STRATEGIES LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STRAT_STATUS = {
  'trying':      { label: 'Trying / To Try', icon: 'üîÑ', color: '#e8f0fe', border: '#a8c0f0', text: '#2a4a8a' },
  'worked':      { label: 'Worked',          icon: '‚úÖ', color: '#e6f4ea', border: '#a0d0a8', text: '#1a5c28' },
  'didnt-work':  { label: "Didn't Work",     icon: '‚ùå', color: '#fce8e8', border: '#f0a8a8', text: '#8a2a2a' }
};

function openAddStrategyInline() {
  document.getElementById('stratTitle').value = '';
  document.getElementById('stratText').value = '';
  document.getElementById('stratStatus').value = 'trying';
  document.getElementById('addStrategyForm').style.display = 'block';
  document.getElementById('stratTitle').focus();
}

function closeAddStrategyInline() {
  document.getElementById('addStrategyForm').style.display = 'none';
}

function saveStrategy() {
  const client = getClient(activeClientId);
  if (!client) return;
  const title = document.getElementById('stratTitle').value.trim();
  const text = document.getElementById('stratText').value.trim();
  const status = document.getElementById('stratStatus').value;
  if (!title) { alert('Please enter a title for this strategy.'); return; }
  if (!client.strategies) client.strategies = [];
  client.strategies.unshift({
    id: Date.now().toString(),
    title,
    text,
    status,
    date: new Date().toLocaleDateString()
  });
  saveState();
  renderStrategies(client);
  closeAddStrategyInline();
}

function openSaveStrategyFromChat(msgId, clientId) {
  const msgEl = document.getElementById(msgId);
  const rawText = msgEl ? msgEl.innerText.trim() : '';
  document.getElementById('modalStratTitle').value = '';
  document.getElementById('modalStratText').value = rawText.substring(0, 1000);
  document.getElementById('modalStratStatus').value = 'trying';
  document.getElementById('modalStratClientId').value = clientId;
  openModal('modalSaveStrategy');
}

function saveStrategyFromModal() {
  const clientId = document.getElementById('modalStratClientId').value;
  const client = getClient(clientId);
  if (!client) return;
  const title = document.getElementById('modalStratTitle').value.trim();
  const text = document.getElementById('modalStratText').value.trim();
  const status = document.getElementById('modalStratStatus').value;
  if (!title) { alert('Please enter a title.'); return; }
  if (!client.strategies) client.strategies = [];
  client.strategies.unshift({
    id: Date.now().toString(),
    title,
    text,
    status,
    date: new Date().toLocaleDateString(),
    source: 'brainstorm'
  });
  saveState();
  // If we're currently viewing this client's strategies tab, refresh it
  if (activeClientId === clientId) renderStrategies(client);
  closeModal('modalSaveStrategy');
  alert(`üí° Strategy saved to ${client.initials}'s profile!`);
}

function renderStrategies(client) {
  const el = document.getElementById('strategiesList');
  if (!el) return;
  const strats = client.strategies || [];
  if (!strats.length) {
    el.innerHTML = `<div style="color:var(--text-muted);font-size:14px;padding:16px 0;text-align:center">No strategies saved yet.<br><span style="font-size:12px">Use the Brainstorming tab and click üí° Save to profile, or add one manually above.</span></div>`;
    return;
  }
  el.innerHTML = strats.map(s => {
    const st = STRAT_STATUS[s.status] || STRAT_STATUS['trying'];
    return `<div class="card" style="margin-bottom:12px;border-left:4px solid ${st.border}">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:15px;margin-bottom:4px">${escapeHtml(s.title)}</div>
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">${s.date}${s.source === 'brainstorm' ? ' ¬∑ from Brainstorming' : ''}</div>
          ${s.text ? `<div style="font-size:13px;line-height:1.65;color:var(--text-mid);white-space:pre-wrap">${escapeHtml(s.text)}</div>` : ''}
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0">
          <span style="background:${st.color};border:1px solid ${st.border};color:${st.text};border-radius:20px;padding:3px 10px;font-size:11px;font-weight:700;white-space:nowrap">${st.icon} ${st.label}</span>
          <div style="display:flex;gap:6px">
            <select onchange="updateStrategyStatus('${s.id}',this.value)" style="font-size:11px;padding:3px 6px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif">
              <option value="trying" ${s.status==='trying'?'selected':''}>üîÑ Trying</option>
              <option value="worked" ${s.status==='worked'?'selected':''}>‚úÖ Worked</option>
              <option value="didnt-work" ${s.status==='didnt-work'?'selected':''}>‚ùå Didn't Work</option>
            </select>
            <button onclick="deleteStrategy('${s.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:2px 4px" title="Delete">üóë</button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function updateStrategyStatus(stratId, newStatus) {
  const client = getClient(activeClientId);
  if (!client?.strategies) return;
  const s = client.strategies.find(s => s.id === stratId);
  if (s) { s.status = newStatus; saveState(); renderStrategies(client); }
}

function deleteStrategy(stratId) {
  if (!confirm('Delete this strategy?')) return;
  const client = getClient(activeClientId);
  if (!client?.strategies) return;
  client.strategies = client.strategies.filter(s => s.id !== stratId);
  saveState();
  renderStrategies(client);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASSWORD / LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_PW = 'bcba2024';

function getStoredPw() {
  return localStorage.getItem('bcba3_pw') || DEFAULT_PW;
}

function checkPassword() {
  const input = document.getElementById('pwInput').value;
  const err = document.getElementById('pwError');
  if (input === getStoredPw()) {
    document.getElementById('loginScreen').classList.remove('visible');
    err.textContent = '';
    document.getElementById('pwInput').value = '';
    // Mark session as authenticated (clears on tab close)
    sessionStorage.setItem('bcba_auth', '1');
  } else {
    err.textContent = 'Incorrect password. Try again.';
    document.getElementById('pwInput').value = '';
    document.getElementById('pwInput').focus();
  }
}

function changePassword() {
  const current = document.getElementById('pwCurrent').value;
  const newPw = document.getElementById('pwNew').value;
  const confirm = document.getElementById('pwConfirm').value;
  const err = document.getElementById('pwChangeError');

  if (current !== getStoredPw()) { err.textContent = 'Current password is incorrect.'; return; }
  if (newPw.length < 4) { err.textContent = 'New password must be at least 4 characters.'; return; }
  if (newPw !== confirm) { err.textContent = 'Passwords do not match.'; return; }

  localStorage.setItem('bcba3_pw', newPw);
  err.textContent = '';
  closeModal('modalChangePw');
  ['pwCurrent','pwNew','pwConfirm'].forEach(id => document.getElementById(id).value = '');
  alert('Password updated! ‚úì');
}

function logout() {
  sessionStorage.removeItem('bcba_auth');
  document.getElementById('loginScreen').classList.add('visible');
  document.getElementById('pwInput').focus();
}

function checkSession() {
  // If already authenticated this session, skip login screen
  if (sessionStorage.getItem('bcba_auth') === '1') {
    document.getElementById('loginScreen').classList.remove('visible');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = { clients: [], apiKey: '', templates: [], chatHistory: [] };
let activeClientId = null;
let recognition = null;
let isRecording = false;

function init() {
  const saved = localStorage.getItem('bcba3_state');
  if (saved) { try { const p = JSON.parse(saved); S.clients = p.clients||[]; S.templates = p.templates||[]; } catch(e){} }
  S.apiKey = localStorage.getItem('bcba3_key') || '';
  if (!S.templates.length) {
    S.templates = [
      { id:'t1', title:'Updated targets', text:'Updated targets for [client] per BCBA direction. New target introduced: [target name].' },
      { id:'t2', title:'Observed session', text:'Observed session with RBT. Client engaged with [activity]. [Behavior] observed [frequency].' },
      { id:'t3', title:'Feedback to RBT ‚Äì strategy implementation', text:'Provided feedback to RBT regarding implementation of [strategy]. Discussed correct procedure and modeled correct response.' },
      { id:'t4', title:'Observed table time (DTT)', text:'Observed DTT table time. Client demonstrated [response] across [number] trials. RBT implementation consistent with program.' },
      { id:'t5', title:'Supported RBT with transition', text:'Supported RBT with transition from [activity] to [activity]. Provided in-vivo coaching on [strategy].' },
      { id:'t6', title:'Parent meeting held', text:'Parent meeting held. Reviewed [goal/behavior] data. Feedback provided regarding [strategy]. Next steps discussed.' },
      { id:'t7', title:'Challenging behavior response', text:'Client engaged in [behavior] during [activity/time]. Implemented [strategy] per BIP. Behavior resolved after [duration].' },
      { id:'t8', title:'Preference assessment conducted', text:'Conducted preference assessment with [client]. Identified [item/activity] as high preference. Updated reinforcer list accordingly.' },
    ];
    saveState();
  }
  renderClients();
  renderTemplates();
  updateApiStatus();
  renderDashboard();
  populateContextDropdowns();
  checkBackupReminder();
  checkSession();
}

function saveState() { localStorage.setItem('bcba3_state', JSON.stringify({ clients: S.clients, templates: S.templates })); }
function saveKey() {
  const k = document.getElementById('apiInput').value.trim();
  if (!k) return;
  S.apiKey = k;
  localStorage.setItem('bcba3_key', k);
  closeModal('modalApiKey');
  updateApiStatus();
}

function updateApiStatus() {
  const has = !!S.apiKey;
  document.getElementById('apiDot').classList.toggle('on', has);
  document.getElementById('apiStatusText').textContent = has ? 'AI Ready' : 'No API key';
  const banner = document.getElementById('setupBanner');
  if (banner) banner.style.display = has ? 'none' : 'block';
  document.querySelectorAll('#bipGenBtn,#rbtGenBtn,#prepGenBtn,#guideGenBtn,#handoutGenBtn,#chatSendBtn,#genTemplatesBtn').forEach(b => b.disabled = !has);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(page, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const t = { dashboard:['Dashboard','All clients overview'], bip:['BIP Generator','Behavior Intervention Plan'], rbt:['RBT Program Sheet','Target description generator'], parent:['Parent Training','Prep, guides & handouts'], stuck:['Brainstorming','Clinical brainstorm & strategy log'], templates:['Note Templates','Reusable phrases for Central Reach'] };
  const info = t[page]||[page,''];
  document.getElementById('tbTitle').textContent = info[0];
  document.getElementById('tbSub').textContent = info[1];
  // Auto-fill initials on generator pages
  if (['bip','rbt','parent'].includes(page)) autoFillInitials();
  if (['bip','rbt','parent','stuck'].includes(page)) populateContextDropdowns();
  if (page === 'dashboard') checkBackupReminder();
  closeSidebar();
}

function switchClientTab(tab, el) {
  ['goals','targets','monitoring','meetings','notes','strategies'].forEach(t => document.getElementById('ct-'+t).style.display = t===tab?'block':'none');
  document.querySelectorAll('#clientProfile .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}

function switchParentTab(tab, el) {
  ['prep','guide','handout'].forEach(t => document.getElementById('pt-'+t).style.display = t===tab?'block':'none');
  document.querySelectorAll('#page-parent .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }
function toggleTsec(id) { const b = document.getElementById(id); b.style.display = b.style.display==='none'?'block':'none'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const empty = document.getElementById('dashEmpty');
  const cards = document.getElementById('clientCards');
  const profile = document.getElementById('clientProfile');
  if (!S.clients.length) {
    empty.style.display = 'block';
    cards.style.display = 'none';
    profile.style.display = 'none';
    return;
  }
  empty.style.display = 'none';
  cards.style.display = 'grid';
  profile.style.display = 'none';

  // Build overdue banner
  const overdueItems = [];
  S.clients.forEach(c => c.monitoring?.forEach(m => { if (getMonitorStatus(m)==='overdue') overdueItems.push(`${c.initials}: ${m.goal}`); }));
  const ob = document.getElementById('overdueBanner');
  ob.innerHTML = overdueItems.length ? `<div class="alert-amber" style="margin-bottom:16px">‚ö†Ô∏è <strong>${overdueItems.length} overdue monitoring item${overdueItems.length>1?'s':''}:</strong> ${overdueItems.slice(0,3).join(', ')}${overdueItems.length>3?'‚Ä¶':''}</div>` : '';

  cards.innerHTML = S.clients.map(c => {
    const overdueCount = (c.monitoring||[]).filter(m => getMonitorStatus(m)==='overdue').length;
    const dueSoon = (c.monitoring||[]).filter(m => getMonitorStatus(m)==='due-soon').length;
    const activeTargets = (c.targets||[]).filter(t => t.status==='active').length;
    const mainGoals = (c.goals||[]).map(g=>g.main).join(', ') || 'No goals set';
    return `<div class="client-card" onclick="openClientProfile('${c.id}')">
      <div class="cc-top">
        <div class="cc-av">${c.initials}</div>
        <div>
          <div class="cc-name">${c.initials}</div>
          <div class="cc-goals">${mainGoals.length > 50 ? mainGoals.substring(0,50)+'‚Ä¶' : mainGoals}</div>
        </div>
      </div>
      <div class="cc-stats">
        <div class="cc-stat">${activeTargets} active target${activeTargets!==1?'s':''}</div>
        ${overdueCount ? `<div class="cc-stat alert">‚ö†Ô∏è ${overdueCount} overdue</div>` : ''}
        ${dueSoon && !overdueCount ? `<div class="cc-stat warn">‚è∞ ${dueSoon} due soon</div>` : ''}
        ${!overdueCount && !dueSoon ? `<div class="cc-stat good">‚úì On track</div>` : ''}
        <div class="cc-stat">${(c.meetings||[]).length} meeting${(c.meetings||[]).length!==1?'s':''} logged</div>
      </div>
    </div>`;
  }).join('');
}

function openClientProfile(id) {
  activeClientId = id;
  renderClients();
  const client = S.clients.find(c => c.id === id);
  if (!client) return;
  document.getElementById('clientCards').style.display = 'none';
  document.getElementById('dashEmpty').style.display = 'none';
  const profile = document.getElementById('clientProfile');
  profile.style.display = 'block';
  document.getElementById('profAv').textContent = client.initials;
  document.getElementById('profName').textContent = client.initials;
  document.getElementById('profMeta').textContent = (client.goals||[]).map(g=>g.main).join(' ¬∑ ') || 'No goals added';
  // reset to goals tab
  ['goals','targets','monitoring','meetings','notes'].forEach(t => document.getElementById('ct-'+t).style.display = t==='goals'?'block':'none');
  document.querySelectorAll('#clientProfile .tab').forEach((t,i) => t.classList.toggle('active', i===0));
  renderGoals(client);
  renderTargets(client);
  renderMonitoring(client);
  renderMeetings(client);
  renderNotes(client);
  renderStrategies(client);
  document.getElementById('tbSub').textContent = client.initials;
}

function showAllClients() {
  activeClientId = null;
  renderClients();
  renderDashboard();
  document.getElementById('clientProfile').style.display = 'none';
  document.getElementById('clientCards').style.display = 'grid';
  document.getElementById('tbSub').textContent = 'All clients overview';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getClient(id) { return S.clients.find(c => c.id === id); }

function saveNewClient() {
  const f = document.getElementById('ncFirst').value.trim();
  const l = document.getElementById('ncLast').value.trim();
  const g = document.getElementById('ncGoals').value.trim();
  if (!f || !l) { alert('Please enter both initials.'); return; }
  const initials = (f+l).replace(/\s/g,'');
  const client = { id: Date.now().toString(), initials, goals:[], targets:[], monitoring:[], meetings:[], notes:[], strategies:[] };
  if (g) g.split(',').forEach(goal => { if (goal.trim()) client.goals.push({ id: Date.now().toString()+Math.random(), main: goal.trim(), subs:[] }); });
  S.clients.push(client);
  saveState();
  renderClients();
  renderDashboard();
  populateContextDropdowns();
  closeModal('modalAddClient');
  ['ncFirst','ncLast','ncGoals'].forEach(id => document.getElementById(id).value='');
}

function renderClients() {
  const el = document.getElementById('clientList');
  if (!S.clients.length) { el.innerHTML='<div style="padding:6px 20px;font-size:12px;color:rgba(255,255,255,0.28)">No clients yet</div>'; return; }
  el.innerHTML = S.clients.map(c => `
    <button class="client-row ${activeClientId===c.id?'active':''}" onclick="selectClientFromSidebar('${c.id}')">
      <div class="ca">${c.initials.substring(0,4)}</div>
      <span style="flex:1">${c.initials}</span>
      <span onclick="event.stopPropagation();deleteClient('${c.id}')" style="color:rgba(255,255,255,0.2);font-size:17px;cursor:pointer;padding:2px 4px">√ó</span>
    </button>`).join('');
}

function selectClientFromSidebar(id) {
  // Navigate to dashboard and open client
  showPage('dashboard', document.querySelector('[data-page="dashboard"]'));
  openClientProfile(id);
}

function deleteClient(id) {
  if (!confirm('Remove this client and all their data?')) return;
  S.clients = S.clients.filter(c => c.id !== id);
  if (activeClientId === id) { activeClientId = null; }
  saveState();
  renderClients();
  renderDashboard();
  populateContextDropdowns();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOALS (with inline editing)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveGoal() {
  const client = getClient(activeClientId);
  if (!client) return;
  const main = document.getElementById('goalMain').value.trim();
  const subsRaw = document.getElementById('goalSubs').value.trim();
  if (!main) { alert('Please enter a main goal.'); return; }
  const subs = subsRaw ? subsRaw.split('\n').filter(s=>s.trim()).map(s=>({id:Date.now().toString()+Math.random(),text:s.trim(),done:false})) : [];
  client.goals.push({ id: Date.now().toString(), main, subs });
  saveState();
  renderGoals(client);
  closeModal('modalAddGoal');
  document.getElementById('goalMain').value='';
  document.getElementById('goalSubs').value='';
}

function renderGoals(client) {
  const el = document.getElementById('goalsList');
  if (!client.goals.length) { el.innerHTML='<div style="color:var(--text-muted);font-size:14px">No goals added yet.</div>'; return; }
  el.innerHTML = client.goals.map((g,gi) => `
    <div class="goal-item" id="goal-${g.id}">
      <div class="goal-header">
        <span style="font-size:15px">üéØ</span>
        <span class="goal-title" id="goalTitle-${g.id}">${g.main}</span>
        <div style="display:flex;gap:6px;margin-left:auto">
          <button class="btn btn-ghost btn-xs" onclick="startEditGoal('${g.id}','${gi}')">‚úèÔ∏è Edit</button>
          <button onclick="deleteGoal(${gi})" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px;padding:2px 4px">√ó</button>
        </div>
      </div>
      ${g.subs.length||true ? `<div class="goal-body">
        ${g.subs.map((s,si) => `
          <div class="subgoal-item" id="sub-${s.id}">
            <input type="checkbox" ${s.done?'checked':''} onchange="toggleSub(${gi},${si})">
            <span class="subgoal-text" id="subText-${s.id}" style="${s.done?'text-decoration:line-through;color:var(--text-muted)':''}">${s.text}</span>
            <button class="btn btn-ghost btn-xs" onclick="startEditSub('${g.id}',${gi},'${s.id}',${si})">‚úèÔ∏è</button>
            <button onclick="deleteSub(${gi},${si})" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:15px">√ó</button>
          </div>`).join('')}
        <div style="margin-top:8px">
          <input type="text" id="newSub-${g.id}" placeholder="Add sub-goal..." style="font-size:13px;padding:6px 10px" onkeydown="if(event.key==='Enter')addSubGoal('${g.id}',${gi})">
          <button class="btn btn-ghost btn-xs" style="margin-top:6px" onclick="addSubGoal('${g.id}',${gi})">Ôºã Add</button>
        </div>
      </div>` : ''}
    </div>`).join('');
}

function startEditGoal(goalId, gi) {
  const titleEl = document.getElementById('goalTitle-'+goalId);
  const current = titleEl.textContent;
  titleEl.outerHTML = `<input class="goal-edit-input" id="goalEditInput-${goalId}" value="${current}" onblur="saveEditGoal('${goalId}',${gi})" onkeydown="if(event.key==='Enter')saveEditGoal('${goalId}',${gi})">`;
  document.getElementById('goalEditInput-'+goalId).focus();
}

function saveEditGoal(goalId, gi) {
  const client = getClient(activeClientId);
  const input = document.getElementById('goalEditInput-'+goalId);
  if (!input) return;
  const newVal = input.value.trim();
  if (newVal) client.goals[gi].main = newVal;
  saveState();
  renderGoals(client);
}

function startEditSub(goalId, gi, subId, si) {
  const textEl = document.getElementById('subText-'+subId);
  const current = textEl.textContent;
  textEl.outerHTML = `<input class="subgoal-edit" id="subEditInput-${subId}" value="${current}" onblur="saveEditSub(${gi},${si},'${subId}')" onkeydown="if(event.key==='Enter')saveEditSub(${gi},${si},'${subId}')">`;
  document.getElementById('subEditInput-'+subId).focus();
}

function saveEditSub(gi, si, subId) {
  const client = getClient(activeClientId);
  const input = document.getElementById('subEditInput-'+subId);
  if (!input) return;
  const newVal = input.value.trim();
  if (newVal) client.goals[gi].subs[si].text = newVal;
  saveState();
  renderGoals(client);
}

function addSubGoal(goalId, gi) {
  const client = getClient(activeClientId);
  const input = document.getElementById('newSub-'+goalId);
  const text = input?.value.trim();
  if (!text) return;
  client.goals[gi].subs.push({ id: Date.now().toString()+Math.random(), text, done: false });
  saveState();
  renderGoals(client);
}

function deleteGoal(gi) {
  const client = getClient(activeClientId);
  if (!client) return;
  client.goals.splice(gi,1);
  saveState();
  renderGoals(client);
}

function deleteSub(gi, si) {
  const client = getClient(activeClientId);
  if (!client) return;
  client.goals[gi].subs.splice(si,1);
  saveState();
  renderGoals(client);
}

function toggleSub(gi, si) {
  const client = getClient(activeClientId);
  if (!client) return;
  client.goals[gi].subs[si].done = !client.goals[gi].subs[si].done;
  saveState();
  renderGoals(client);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TARGETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveTarget() {
  const client = getClient(activeClientId);
  if (!client) return;
  const name = document.getElementById('targetName').value.trim();
  const status = document.getElementById('targetStatus').value;
  const notes = document.getElementById('targetNotes').value.trim();
  if (!name) { alert('Please enter a target name.'); return; }
  client.targets.push({ id: Date.now().toString(), name, status, notes });
  saveState();
  renderTargets(client);
  closeModal('modalAddTarget');
  ['targetName','targetNotes'].forEach(id => document.getElementById(id).value='');
  document.getElementById('targetStatus').value='active';
}

function renderTargets(client) {
  const groups = { active:'targetsActive', mastered:'targetsMastered', discontinued:'targetsDiscontinued' };
  const cls = { active:'ts-active', mastered:'ts-mastered', discontinued:'ts-disc' };
  const lbl = { active:'Active', mastered:'Mastered', discontinued:'Discontinued' };
  Object.keys(groups).forEach(status => {
    const items = client.targets.filter(t => t.status===status);
    const el = document.getElementById(groups[status]);
    if (!items.length) { el.innerHTML='<div style="color:var(--text-muted);font-size:13px;padding:4px 0">None</div>'; return; }
    el.innerHTML = items.map(t => `
      <div class="target-item">
        <div>
          <div style="font-weight:600">${t.name}</div>
          ${t.notes?`<div style="font-size:12px;color:var(--text-muted)">${t.notes}</div>`:''}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="target-status ${cls[status]}">${lbl[status]}</span>
          <button onclick="deleteTarget('${t.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px">√ó</button>
        </div>
      </div>`).join('');
  });
}

function deleteTarget(id) {
  const client = getClient(activeClientId);
  if (!client) return;
  client.targets = client.targets.filter(t => t.id!==id);
  saveState();
  renderTargets(client);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MONITORING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddMonitor() {
  const client = getClient(activeClientId);
  const select = document.getElementById('monGoalSelect');

  // Reset fields
  document.getElementById('monGoal').value = '';
  document.getElementById('monDate').value = '';
  document.getElementById('monLastDate').value = '';
  document.getElementById('monFreq').value = 'weekly';

  // Build grouped dropdown from client's goals and targets
  let options = '<option value="">‚Äî Pick from existing goals or targets ‚Äî</option>';

  const goals = client?.goals || [];
  const targets = client?.targets?.filter(t => t.status === 'active') || [];
  const masteredTargets = client?.targets?.filter(t => t.status === 'mastered') || [];

  if (goals.length) {
    options += '<optgroup label="‚îÄ‚îÄ Goals ‚îÄ‚îÄ">';
    goals.forEach(g => {
      options += `<option value="${escapeHtml(g.main)}">üéØ ${escapeHtml(g.main)}</option>`;
      g.subs.forEach(s => {
        options += `<option value="${escapeHtml(s.text)}">„ÄÄ‚Ü≥ ${escapeHtml(s.text)}</option>`;
      });
    });
    options += '</optgroup>';
  }

  if (targets.length) {
    options += '<optgroup label="‚îÄ‚îÄ Active Targets ‚îÄ‚îÄ">';
    targets.forEach(t => {
      options += `<option value="${escapeHtml(t.name)}">üìå ${escapeHtml(t.name)}</option>`;
    });
    options += '</optgroup>';
  }

  if (masteredTargets.length) {
    options += '<optgroup label="‚îÄ‚îÄ Mastered Targets ‚îÄ‚îÄ">';
    masteredTargets.forEach(t => {
      options += `<option value="${escapeHtml(t.name)}">‚úì ${escapeHtml(t.name)}</option>`;
    });
    options += '</optgroup>';
  }

  if (!goals.length && !targets.length && !masteredTargets.length) {
    options += '<option value="" disabled>No goals or targets added yet ‚Äî type below</option>';
  }

  select.innerHTML = options;
  openModal('modalAddMonitor');
}

function handleMonitorSelect(value) {
  if (value) {
    document.getElementById('monGoal').value = value;
    // Reset the dropdown back to placeholder so it's clear the text field is the source of truth
    document.getElementById('monGoalSelect').value = '';
  }
}

function saveMonitor() {
  const client = getClient(activeClientId);
  if (!client) return;
  const goal = document.getElementById('monGoal').value.trim();
  const date = document.getElementById('monDate').value.trim();
  const freq = document.getElementById('monFreq').value;
  const lastDate = document.getElementById('monLastDate').value.trim();
  if (!goal) { alert('Please select or enter a goal/behavior to monitor.'); return; }
  client.monitoring.push({ id: Date.now().toString(), goal, date, freq, lastDate });
  saveState();
  renderMonitoring(client);
  closeModal('modalAddMonitor');
  ['monGoal','monDate','monLastDate'].forEach(id => document.getElementById(id).value='');
}

function renderMonitoring(client) {
  const el = document.getElementById('monitorList');
  if (!client.monitoring.length) { el.innerHTML='<div style="color:var(--text-muted);font-size:14px">No monitoring items added.</div>'; return; }
  el.innerHTML = client.monitoring.map(m => {
    const status = getMonitorStatus(m);
    const cls = status==='overdue'?'overdue':status==='due-soon'?'due-soon':'';
    const badge = status==='overdue'?'<span class="badge badge-rose">Overdue</span>':status==='due-soon'?'<span class="badge badge-amber">Due Soon</span>':'<span class="badge badge-sage">On Track</span>';
    return `<div class="monitor-item ${cls}">
      <div>
        <div style="font-weight:600">${m.goal}</div>
        <div style="font-size:12px;color:var(--text-muted)">${m.freq} ¬∑ Last tracked: ${m.lastDate||'Not yet'} ¬∑ Started: ${m.date||'Unknown'}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        ${badge}
        <button onclick="updateLastTracked('${m.id}')" class="btn btn-ghost btn-xs" style="color:var(--sage)">‚úì Mark tracked</button>
        <button onclick="deleteMonitor('${m.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px">√ó</button>
      </div>
    </div>`;
  }).join('');
}

function getMonitorStatus(m) {
  if (!m.lastDate) return 'overdue';
  const last = new Date(m.lastDate);
  const now = new Date();
  const diffDays = Math.floor((now-last)/86400000);
  const limits = { daily:1, weekly:7, biweekly:14, monthly:30 };
  const limit = limits[m.freq]||7;
  if (diffDays > limit) return 'overdue';
  if (diffDays > limit*0.75) return 'due-soon';
  return 'ok';
}

function updateLastTracked(id) {
  const client = getClient(activeClientId);
  const m = client?.monitoring.find(x => x.id===id);
  if (!m) return;
  m.lastDate = new Date().toLocaleDateString('en-US');
  saveState();
  renderMonitoring(client);
  renderDashboard();
}

function deleteMonitor(id) {
  const client = getClient(activeClientId);
  if (!client) return;
  client.monitoring = client.monitoring.filter(m => m.id!==id);
  saveState();
  renderMonitoring(client);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEETINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveMeeting() {
  const client = getClient(activeClientId);
  if (!client) return;
  const date = document.getElementById('meetDate').value.trim();
  const topics = document.getElementById('meetTopics').value.trim();
  const feedback = document.getElementById('meetFeedback').value.trim();
  const followup = document.getElementById('meetFollowup').value.trim();
  if (!topics) { alert('Please enter topics discussed.'); return; }
  client.meetings.unshift({ id: Date.now().toString(), date, topics, feedback, followup });
  saveState();
  renderMeetings(client);
  renderDashboard();
  closeModal('modalAddMeeting');
  ['meetDate','meetTopics','meetFeedback','meetFollowup'].forEach(id => document.getElementById(id).value='');
}

function renderMeetings(client) {
  const el = document.getElementById('meetingList');
  if (!client.meetings.length) { el.innerHTML='<div style="color:var(--text-muted);font-size:14px">No meetings logged yet.</div>'; return; }
  el.innerHTML = client.meetings.map(m => `
    <div class="meeting-entry">
      <div class="meeting-head" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
        <span style="font-weight:700">${m.date||'No date'}</span>
        <span style="font-size:13px;color:var(--text-muted)">${m.topics.substring(0,55)}${m.topics.length>55?'‚Ä¶':''}</span>
        <button onclick="event.stopPropagation();deleteMeeting('${m.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px">√ó</button>
      </div>
      <div class="meeting-body" style="display:none">
        ${m.topics?`<strong>Topics:</strong>\n${m.topics}\n\n`:''}${m.feedback?`<strong>Feedback given:</strong>\n${m.feedback}\n\n`:''}${m.followup?`<strong>Follow-up:</strong>\n${m.followup}`:''}
      </div>
    </div>`).join('');
}

function deleteMeeting(id) {
  const client = getClient(activeClientId);
  if (!client) return;
  client.meetings = client.meetings.filter(m => m.id!==id);
  saveState();
  renderMeetings(client);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION NOTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveClientNote() {
  const client = getClient(activeClientId);
  if (!client) return;
  const text = document.getElementById('noteText').value.trim();
  if (!text) { alert('Please enter some notes.'); return; }
  client.notes.unshift({ id: Date.now().toString(), date: new Date().toLocaleDateString('en-US'), text });
  saveState();
  renderNotes(client);
  document.getElementById('noteText').value='';
}

function renderNotes(client) {
  const el = document.getElementById('notesList');
  if (!client.notes?.length) { el.innerHTML='<div style="color:var(--text-muted);font-size:14px;padding:8px 0">No notes saved yet.</div>'; return; }
  el.innerHTML = client.notes.map(n => `
    <div style="border:1.5px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;background:var(--surface)">
      <div style="font-size:12px;color:var(--text-muted);margin-bottom:5px">${n.date}</div>
      <div style="font-size:14px;white-space:pre-wrap;line-height:1.7">${escapeHtml(n.text)}</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-ghost btn-xs" onclick="copyById('note','${n.id}')">üìã Copy</button>
        <button onclick="deleteNote('${n.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:13px">Delete</button>
      </div>
    </div>`).join('');
}

function deleteNote(id) {
  const client = getClient(activeClientId);
  if (!client) return;
  client.notes = client.notes.filter(n => n.id!==id);
  saveState();
  renderNotes(client);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTE TEMPLATES (with editing + multi-select)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedTemplates = new Set();

function openAddTemplateInline() {
  document.getElementById('addTemplateForm').style.display = 'block';
  document.getElementById('tplTitle').focus();
}

function closeAddTemplate() {
  document.getElementById('addTemplateForm').style.display = 'none';
  document.getElementById('tplTitle').value='';
  document.getElementById('tplText').value='';
}

function saveTemplate() {
  const title = document.getElementById('tplTitle').value.trim();
  const text = document.getElementById('tplText').value.trim();
  if (!title||!text) { alert('Please fill in both fields.'); return; }
  S.templates.push({ id: Date.now().toString(), title, text });
  saveState();
  renderTemplates();
  closeAddTemplate();
}

function toggleTemplateSelect(id) {
  if (selectedTemplates.has(id)) { selectedTemplates.delete(id); } else { selectedTemplates.add(id); }
  renderTemplates();
  updateCopySelectedBtn();
}

function updateCopySelectedBtn() {
  const btn = document.getElementById('copySelectedBtn');
  const count = document.getElementById('selectedCount');
  if (selectedTemplates.size > 0) {
    btn.style.display = 'inline-flex';
    count.textContent = selectedTemplates.size;
  } else {
    btn.style.display = 'none';
  }
}

function clearSelection() {
  selectedTemplates.clear();
  renderTemplates();
  updateCopySelectedBtn();
}

function copySelectedTemplates() {
  const texts = S.templates.filter(t => selectedTemplates.has(t.id)).map(t => t.text);
  if (!texts.length) { alert('No templates selected.'); return; }
  navigator.clipboard.writeText(texts.join('\n\n')).then(() => {
    alert(`Copied ${texts.length} template${texts.length>1?'s':''} to clipboard!`);
    selectedTemplates.clear();
    renderTemplates();
    updateCopySelectedBtn();
  });
}

function startEditTemplate(id) {
  const t = S.templates.find(x => x.id===id);
  if (!t) return;
  const el = document.getElementById('tpl-'+id);
  el.innerHTML = `
    <div onclick="event.stopPropagation()" style="width:100%">
      <input class="tpl-edit-title" id="etTitle-${id}" value="${t.title.replace(/"/g,'&quot;')}">
      <textarea class="tpl-edit-text" id="etText-${id}">${t.text}</textarea>
      <div class="btn-row" style="margin-top:8px">
        <button class="btn btn-ghost btn-xs" onclick="cancelEditTemplate('${id}')">Cancel</button>
        <button class="btn btn-primary btn-xs" onclick="saveEditTemplate('${id}')">Save</button>
      </div>
    </div>`;
}

function saveEditTemplate(id) {
  const t = S.templates.find(x => x.id===id);
  if (!t) return;
  t.title = document.getElementById('etTitle-'+id).value.trim() || t.title;
  t.text = document.getElementById('etText-'+id).value.trim() || t.text;
  saveState();
  renderTemplates();
}

function cancelEditTemplate(id) { renderTemplates(); }

function deleteTemplate(id) {
  S.templates = S.templates.filter(t => t.id!==id);
  selectedTemplates.delete(id);
  saveState();
  renderTemplates();
  updateCopySelectedBtn();
}

function renderTemplates() {
  const el = document.getElementById('templatesList');
  if (!S.templates.length) { el.innerHTML='<div class="empty"><div class="empty-icon">üóÇ</div><div class="empty-title">No templates yet</div><div class="empty-text">Add your first template above.</div></div>'; return; }
  el.innerHTML = S.templates.map(t => {
    const sel = selectedTemplates.has(t.id);
    return `<div class="tpl-item ${sel?'selected':''}" id="tpl-${t.id}">
      <div class="tpl-check" onclick="toggleTemplateSelect('${t.id}')">${sel?'‚úì':''}</div>
      <div class="tpl-content">
        <div class="tpl-title">${t.title}</div>
        <div class="tpl-preview">${t.text.substring(0,90)}${t.text.length>90?'‚Ä¶':''}</div>
      </div>
      <div class="tpl-actions">
        <button class="btn btn-ghost btn-xs" onclick="copyById('tpl','${t.id}')">üìã</button>
        <button class="btn btn-ghost btn-xs" onclick="startEditTemplate('${t.id}')">‚úèÔ∏è</button>
        <button onclick="deleteTemplate('${t.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px;padding:2px 6px">√ó</button>
      </div>
    </div>`;
  }).join('');
}

async function generateDefaultTemplates() {
  const btn = document.getElementById('genTemplatesBtn');
  btn.innerHTML = '<span class="ld"><span></span><span></span><span></span></span> Generating‚Ä¶';
  btn.disabled = true;
  const result = await callClaude(
    'You are a BCBA generating concise session note templates for Central Reach documentation. Short, objective, fill-in-the-bracket style. No jargon.',
    'Generate 6 additional BCBA session note templates. Format as JSON array only: [{"title":"short label","text":"template text with [brackets] for fill-ins"}]. Cover: updating mastery criteria, parent feedback, problem behavior during session, reviewing data trends, preference assessment, conducting probe.'
  );
  btn.innerHTML = '‚ú® Generate Suggestions';
  btn.disabled = false;
  if (!result) return;
  try {
    const items = JSON.parse(result.replace(/```json|```/g,'').trim());
    items.forEach(item => S.templates.push({ id: Date.now().toString()+Math.random(), title:item.title, text:item.text }));
    saveState();
    renderTemplates();
  } catch(e) { alert('Could not parse suggestions. Try again.'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ABA_SYS = `You are a highly experienced Board Certified Behavior Analyst (BCBA). Clinical precision and brevity.
RULES: Short objective sentences. Plain language ‚Äî families may read this. No overclaiming. No superlatives unless stated by clinician. Describe observable, measurable behaviors. ABA terminology must be accurate. Proactive/reactive strategies grounded in identified function. Do not invent data.`;

async function callClaude(system, user, messages) {
  if (!S.apiKey) { openModal('modalApiKey'); return null; }
  try {
    const body = { model:'claude-sonnet-4-20250514', max_tokens:2000, system };
    if (messages) { body.messages = messages; } else { body.messages = [{role:'user',content:user}]; }
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':S.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body: JSON.stringify(body)
    });
    if (!res.ok) { const e = await res.json().catch(()=>{}); alert('API Error: '+(e?.error?.message||res.status)); return null; }
    const data = await res.json();
    return data.content?.[0]?.text||'';
  } catch(e) { alert('Network error. Check connection and API key.'); return null; }
}

function extractSec(text, start, end) {
  const s='=== '+start+' ===';
  const si=text.indexOf(s);
  if(si===-1) return text;
  const ci=si+s.length;
  const ei=end?text.indexOf('=== '+end+' ===',ci):-1;
  return (ei===-1?text.slice(ci):text.slice(ci,ei)).trim();
}

async function generateBIP() {
  const clientCtx = getSelectedContext('bip');
  const client = document.getElementById('bipClient').value.trim()||'Client';
  const behavior = document.getElementById('bipBehavior').value.trim();
  const desc = document.getElementById('bipDesc').value.trim();
  const func = document.getElementById('bipFunction').value.trim();
  const reinf = document.getElementById('bipReinf').value.trim();
  const ctx = document.getElementById('bipContext').value.trim();
  if (!behavior||!desc) { alert('Please enter the behavior name and description.'); return; }
  const btn=document.getElementById('bipGenBtn');
  btn.innerHTML='<span class="ld"><span></span><span></span><span></span></span> Generating‚Ä¶';
  btn.disabled=true;

  const systemPrompt = clientCtx
    ? ABA_SYS + `\n\nYou have access to this client's full profile. Use it to inform all sections ‚Äî reference known goals, targets, reinforcers, and meeting history where relevant.\n\n${clientCtx}`
    : ABA_SYS;

  const prompt=`Client: ${client}\nBehavior: ${behavior}\nDescription: ${desc}\n${func?'Hypothesized Function: '+func:'Function: Derive from description'}\n${reinf?'Known Reinforcers: '+reinf:''}\n${ctx?'Additional Context: '+ctx:''}\n\nGenerate a BIP using EXACTLY these section headers:\n\n=== BEHAVIOR DEFINITION ===\nOperational definition with:\n- Onset: [topographic description of how behavior begins]\n- Offset: [topographic description of how behavior ends]\n- Example: [brief concrete example]\n- Non-example: [what does NOT count]\n\n=== FUNCTION ===\nState concisely. If derived from description only, note hypothesized.\n\n=== ANTECEDENTS ===\nTimes, activities, conditions when behavior most likely occurs.\n\n=== REINFORCERS ===\nItems, people, activities that function as reinforcers.\n\n=== PROACTIVE STRATEGIES ===\nAntecedent manipulations grounded in function. Concrete and measurable.\n\n=== REACTIVE STRATEGIES ===\nWhat to do when behavior occurs. Function-based. Include what NOT to do.`;
  const result = await callClaude(systemPrompt, prompt);
  btn.innerHTML='‚ú® Generate BIP Draft'; btn.disabled=false;
  if (!result) return;
  const secs={'bip-behavior':extractSec(result,'BEHAVIOR DEFINITION','FUNCTION'),'bip-function':extractSec(result,'FUNCTION','ANTECEDENTS'),'bip-antecedents':extractSec(result,'ANTECEDENTS','REINFORCERS'),'bip-reinforcers':extractSec(result,'REINFORCERS','PROACTIVE STRATEGIES'),'bip-proactive':extractSec(result,'PROACTIVE STRATEGIES','REACTIVE STRATEGIES'),'bip-reactive':extractSec(result,'REACTIVE STRATEGIES',null)};
  Object.keys(secs).forEach(id => { document.getElementById(id).textContent=secs[id]; document.getElementById(id).style.display='block'; });
  document.getElementById('bipClientBadge').textContent=client;
  document.getElementById('bipFullText').textContent=result;
  document.getElementById('bipOutput').style.display='block';
  document.getElementById('bipOutput').scrollIntoView({behavior:'smooth'});
}

async function generateRBT() {
  const clientCtx = getSelectedContext('rbt');
  const client=document.getElementById('rbtClient').value.trim()||'Client';
  const target=document.getElementById('rbtTarget').value.trim();
  const desc=document.getElementById('rbtDesc').value.trim();
  const reinf=document.getElementById('rbtReinf').value.trim();
  const prompts=document.getElementById('rbtPrompts').value.trim();
  const env=document.getElementById('rbtEnv').value;
  const presentation=document.getElementById('rbtPresentation').value;
  const notes=document.getElementById('rbtNotes').value.trim();
  if (!target||!desc) { alert('Please enter the target name and description.'); return; }
  const btn=document.getElementById('rbtGenBtn');
  btn.innerHTML='<span class="ld"><span></span><span></span><span></span></span> Generating‚Ä¶';
  btn.disabled=true;
  const systemPrompt = clientCtx
    ? ABA_SYS + `\n\nYou have access to this client's full profile. Use it to inform the program sheet ‚Äî reference existing goals, mastered targets, and known reinforcers where relevant.\n\n${clientCtx}`
    : ABA_SYS;
  const prompt=`Client: ${client}\nTarget: ${target}\nDescription: ${desc}\nKnown Reinforcers: ${reinf||'not specified'}\nPrompting Strategies: ${prompts||'least to most'}\nEnvironment: ${env}\nTarget Presentation: ${presentation}\nNotes: ${notes||'none'}\n\nGenerate an RBT target description with EXACTLY these fields in order. Short phrases, not paragraphs:\n\nProcedures/Other Notes:\nSD:\nDefinition of desired behavior / correct response:\nStimuli Presentation:\nMaterials:\nPrompting Strategies:\nDefinition for Undesired Target Behaviors:\nError Correction Procedure:\nReinforcement:\nEnvironment/Context:\nTarget Presentation:\nTrials:`;
  const result = await callClaude(systemPrompt, prompt);
  btn.innerHTML='‚ú® Generate Program Sheet'; btn.disabled=false;
  if (!result) return;
  document.getElementById('rbtClientBadge').textContent=`${client} ¬∑ ${target}`;
  renderRBTFields(result);
  document.getElementById('rbtOutput').style.display='block';
  document.getElementById('rbtOutput').scrollIntoView({behavior:'smooth'});
}

function addAnotherRBT() {
  document.getElementById('rbtOutput').style.display='none';
  document.getElementById('rbtFieldsWrap').innerHTML='';
  document.getElementById('rbtRawHidden').textContent='';
  document.getElementById('rbtTarget').value='';
  document.getElementById('rbtDesc').value='';
  document.getElementById('rbtNotes').value='';
  document.getElementById('rbtTarget').focus();
  window.scrollTo(0,0);
}

async function generatePrep() {
  const clientCtx = getSelectedContext('parent');
  const client=document.getElementById('prepClient').value.trim()||'Client';
  const date=document.getElementById('prepDate').value.trim();
  const topics=document.getElementById('prepTopics').value.trim();
  const followup=document.getElementById('prepFollowup').value.trim();
  if (!topics) { alert('Please describe what to cover.'); return; }
  const btn=document.getElementById('prepGenBtn');
  btn.innerHTML='<span class="ld"><span></span><span></span><span></span></span> Generating‚Ä¶'; btn.disabled=true;
  const systemPrompt = clientCtx
    ? ABA_SYS + `\n\nYou have access to this client's full profile including meeting history. Use it to make the agenda specific and relevant.\n\n${clientCtx}`
    : ABA_SYS;
  const result = await callClaude(systemPrompt, `Client: ${client}\nMeeting Date: ${date||'upcoming'}\nTopics: ${topics}\n${followup?'Last meeting follow-up: '+followup:''}\n\nGenerate a BCBA pre-meeting agenda. Structure: opening check-in, follow-up items, goal updates with talking points, data points to share, feedback to deliver, closing. Bullet points. BCBA-facing, not parent-facing.`);
  btn.innerHTML='‚ú® Generate Agenda'; btn.disabled=false;
  if (!result) return;
  document.getElementById('prepResult').textContent=result;
  document.getElementById('prepOutput').style.display='block';
  document.getElementById('prepOutput').scrollIntoView({behavior:'smooth'});
}

async function generateGuide() {
  const clientCtx = getSelectedContext('parent');
  const client=document.getElementById('guideClient').value.trim()||'Client';
  const focus=document.getElementById('guideFocus').value.trim();
  const goals=document.getElementById('guideGoals').value.trim();
  const concerns=document.getElementById('guideConcerns').value.trim();
  if (!goals) { alert('Please enter goals to discuss.'); return; }
  const btn=document.getElementById('guideGenBtn');
  btn.innerHTML='<span class="ld"><span></span><span></span><span></span></span> Generating‚Ä¶'; btn.disabled=true;
  const systemPrompt = clientCtx
    ? ABA_SYS + `\n\nYou have access to this client's full profile including past meeting notes. Use them to make the during-meeting guide specific, referencing real history where helpful.\n\n${clientCtx}`
    : ABA_SYS;
  const result = await callClaude(systemPrompt, `Client: ${client}\nFocus: ${focus||'general'}\nGoals/behaviors: ${goals}\n${concerns?'Family concerns: '+concerns:''}\n\nGenerate a during-meeting guide the BCBA keeps open on phone/laptop during session. Natural meeting flow: warm opening prompts, transition to goals, talking points per goal with simple language for data trends, questions to ask family, strategies to reinforce, how to handle new concerns, closing. Conversational and scannable.`);
  btn.innerHTML='‚ú® Generate Meeting Guide'; btn.disabled=false;
  if (!result) return;
  document.getElementById('guideResult').textContent=result;
  document.getElementById('guideOutput').style.display='block';
  document.getElementById('guideOutput').scrollIntoView({behavior:'smooth'});
}

async function generateHandout() {
  const clientCtx = getSelectedContext('parent');
  const client=document.getElementById('handoutClient').value.trim()||'Client';
  const topic=document.getElementById('handoutTopic').value.trim();
  const strats=document.getElementById('handoutStrats').value.trim();
  const data=document.getElementById('handoutData').value.trim();
  if (!topic) { alert('Please enter the topic.'); return; }
  const btn=document.getElementById('handoutGenBtn');
  btn.innerHTML='<span class="ld"><span></span><span></span><span></span></span> Generating‚Ä¶'; btn.disabled=true;
  const systemPrompt = clientCtx
    ? ABA_SYS + `\n\nYou have access to this client's full profile. Use it to make the handout specific to their situation and goals.\n\n${clientCtx}`
    : ABA_SYS;
  const result = await callClaude(systemPrompt, `Client: ${client}\nTopic: ${topic}\nStrategies: ${strats||'general best practices'}\nData collection: ${data||'record each instance'}\n\nGenerate a parent take-home handout. Written for a parent with no clinical background. Include: plain language explanation of the goal, numbered steps to follow at home, brief "do not" list, quick reference reminders for fridge, simple data tracking instructions, brief encouraging note. Short sentences. Warm tone. No jargon.`);
  btn.innerHTML='‚ú® Generate Handout'; btn.disabled=false;
  if (!result) return;
  document.getElementById('handoutResult').textContent=result;
  document.getElementById('handoutOutput').style.display='block';
  document.getElementById('handoutOutput').scrollIntoView({behavior:'smooth'});
}

// CHAT
function chatKeydown(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();} }

async function sendChat() {
  const clientCtx = getSelectedContext('stuck');
  const input=document.getElementById('chatInput');
  const text=input.value.trim();
  if (!text) return;
  S.chatHistory.push({role:'user',content:text});
  appendMsg('user',text);
  input.value='';
  const btn=document.getElementById('chatSendBtn');
  btn.disabled=true; btn.innerHTML='<span class="ld"><span></span><span></span><span></span></span>';
  const system = clientCtx
    ? ABA_SYS + `\n\nYou are a trusted clinical thinking partner for a BCBA. Be collaborative, not lecture-y. Offer concrete evidence-based ABA ideas. Help brainstorm interventions, think through function, suggest assessments, develop goals. Remember the full conversation.\n\nYou have full access to this client's profile. Use it to give specific, informed responses ‚Äî reference their actual goals, targets, and history rather than speaking generally.\n\n${clientCtx}`
    : ABA_SYS + `\n\nYou are a trusted clinical thinking partner for a BCBA. Be collaborative, not lecture-y. Offer concrete evidence-based ABA ideas. Help brainstorm interventions, think through function, suggest assessments, develop goals. Remember the full conversation.`;
  const result = await callClaude(system, null, S.chatHistory);
  const reply = result||'Sorry, I had trouble generating a response.';
  S.chatHistory.push({role:'assistant',content:reply});
  appendMsg('ai',reply);
  btn.disabled=false; btn.innerHTML='Send';
}

function appendMsg(role, text) {
  const c=document.getElementById('chatMessages');
  const div=document.createElement('div');
  div.className='msg '+(role==='user'?'msg-user':'msg-ai');
  if (role==='ai') {
    const msgId = 'msg_' + Date.now();
    div.innerHTML=`<div class="msg-label">BCBA Assistant</div><div id="${msgId}">${text.replace(/\n/g,'<br>')}</div>`;
    // Add save button if a client is selected
    const sel = document.getElementById('stuckClientSelect');
    if (sel?.value) {
      const client = getClient(sel.value);
      const saveBtn = document.createElement('div');
      saveBtn.style.cssText = 'margin-top:8px;display:flex;justify-content:flex-end';
      saveBtn.innerHTML = `<button onclick="openSaveStrategyFromChat('${msgId}','${sel.value}')" style="background:var(--sage-light);border:1px solid #b0d0b5;border-radius:7px;padding:4px 10px;font-size:11px;font-weight:700;color:var(--sage-dark);cursor:pointer;font-family:'Nunito',sans-serif">üí° Save to ${client?.initials||'profile'}</button>`;
      div.appendChild(saveBtn);
    }
  } else {
    div.textContent=text;
  }
  c.appendChild(div);
  c.scrollTop=c.scrollHeight;
}

function clearChat() {
  S.chatHistory=[];
  document.getElementById('chatMessages').innerHTML=`<div class="msg msg-ai"><div class="msg-label">BCBA Assistant</div>Tell me what's going on. Describe the behavior, the context, what you've tried, and what isn't working. The more detail you give me, the more useful I can be. üíö</div>`;
}

// SPEECH TO TEXT
function toggleMic(targetId, btnId) {
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){alert('Speech recognition not supported. Try Chrome or Safari.');return;}
  const btn=document.getElementById(btnId);
  if(isRecording){recognition?.stop();return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR();
  recognition.continuous=true; recognition.interimResults=true; recognition.lang='en-US';
  isRecording=true; btn.classList.add('recording'); btn.textContent='üî¥ Stop';
  let final=document.getElementById(targetId).value;
  recognition.onresult=(e)=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal){final+=' '+e.results[i][0].transcript;}else{interim+=e.results[i][0].transcript;}
    }
    document.getElementById(targetId).value=final+(interim?' '+interim:'');
  };
  recognition.onend=()=>{isRecording=false;btn.classList.remove('recording');btn.innerHTML=btnId==='micChat'?'üé§':'üé§ Dictate';};
  recognition.onerror=()=>{isRecording=false;btn.classList.remove('recording');btn.innerHTML=btnId==='micChat'?'üé§':'üé§ Dictate';};
  recognition.start();
}

// UTILITIES
function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function copyById(type, id) {
  let text = '';
  if (type === 'note') {
    const client = getClient(activeClientId);
    const note = client?.notes.find(n => n.id === id);
    text = note?.text || '';
  } else if (type === 'tpl') {
    const tpl = S.templates.find(t => t.id === id);
    text = tpl?.text || '';
  }
  if (text) navigator.clipboard.writeText(text).then(() => alert('Copied!'));
}

function copyText(elId){navigator.clipboard.writeText(document.getElementById(elId).textContent).then(()=>alert('Copied!'));}
function copyEl(elId){navigator.clipboard.writeText(document.getElementById(elId).textContent).then(()=>alert('Copied!'));}

function printEl(elId, title) {
  const text=document.getElementById(elId).textContent;
  document.getElementById('printArea').innerHTML=`<div style="font-family:Georgia,serif;max-width:680px;margin:0 auto;padding:32px;color:#2d2820"><h1 style="font-size:20px;margin-bottom:20px">${title}</h1><pre style="white-space:pre-wrap;font-size:13px;line-height:1.8;font-family:Georgia,serif">${text}</pre></div>`;
  window.print();
}

function printBIP() {
  const client=document.getElementById('bipClientBadge').textContent;
  const secs=[['bip-behavior','Behavior Definition'],['bip-function','Function'],['bip-antecedents','Antecedents'],['bip-reinforcers','Reinforcers'],['bip-proactive','Proactive Strategies'],['bip-reactive','Reactive Strategies']];
  document.getElementById('printArea').innerHTML=`<div style="font-family:Georgia,serif;max-width:680px;margin:0 auto;padding:32px;color:#2d2820"><h1 style="font-size:20px;margin-bottom:4px">Behavior Intervention Plan</h1><p style="font-size:12px;color:#888;margin-bottom:24px">Client: ${client} ¬∑ ${new Date().toLocaleDateString()}</p>${secs.map(([id,lbl])=>`<h2 style="font-size:14px;margin:20px 0 6px;text-transform:uppercase;letter-spacing:0.5px;color:#5a7a5f">${lbl}</h2><pre style="white-space:pre-wrap;font-size:13px;line-height:1.8;font-family:Georgia,serif">${document.getElementById(id).textContent}</pre>`).join('')}</div>`;
  window.print();
}

function printRBT() {
  const badge=document.getElementById('rbtClientBadge').textContent;
  const text=document.getElementById('rbtRawHidden').textContent;
  document.getElementById('printArea').innerHTML=`<div style="font-family:Georgia,serif;max-width:680px;margin:0 auto;padding:32px;color:#2d2820"><h1 style="font-size:20px;margin-bottom:4px">RBT Program Sheet</h1><p style="font-size:12px;color:#888;margin-bottom:24px">${badge} ¬∑ ${new Date().toLocaleDateString()}</p><pre style="white-space:pre-wrap;font-size:14px;line-height:1.9;font-family:Georgia,serif">${text}</pre></div>`;
  window.print();
}

function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

init();
</script>
</body>
</html>
